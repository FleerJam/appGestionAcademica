<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>utilities.importer_window API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../utilities.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;utilities</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#WorkerProcesamiento">WorkerProcesamiento</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#WorkerProcesamiento.__init__">WorkerProcesamiento</a>
                        </li>
                        <li>
                                <a class="function" href="#WorkerProcesamiento.finished">finished</a>
                        </li>
                        <li>
                                <a class="function" href="#WorkerProcesamiento.error">error</a>
                        </li>
                        <li>
                                <a class="variable" href="#WorkerProcesamiento.path">path</a>
                        </li>
                        <li>
                                <a class="variable" href="#WorkerProcesamiento.curso">curso</a>
                        </li>
                        <li>
                                <a class="variable" href="#WorkerProcesamiento.mapa_manual">mapa_manual</a>
                        </li>
                        <li>
                                <a class="variable" href="#WorkerProcesamiento.mapa_actividades">mapa_actividades</a>
                        </li>
                        <li>
                                <a class="variable" href="#WorkerProcesamiento.esquema_ponderacion">esquema_ponderacion</a>
                        </li>
                        <li>
                                <a class="variable" href="#WorkerProcesamiento.persistence">persistence</a>
                        </li>
                        <li>
                                <a class="function" href="#WorkerProcesamiento.run">run</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#WorkerGuardado">WorkerGuardado</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#WorkerGuardado.__init__">WorkerGuardado</a>
                        </li>
                        <li>
                                <a class="function" href="#WorkerGuardado.finished">finished</a>
                        </li>
                        <li>
                                <a class="function" href="#WorkerGuardado.error">error</a>
                        </li>
                        <li>
                                <a class="variable" href="#WorkerGuardado.service">service</a>
                        </li>
                        <li>
                                <a class="variable" href="#WorkerGuardado.lista">lista</a>
                        </li>
                        <li>
                                <a class="variable" href="#WorkerGuardado.curso_id">curso_id</a>
                        </li>
                        <li>
                                <a class="function" href="#WorkerGuardado.run">run</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GestorImportacion">GestorImportacion</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GestorImportacion.__init__">GestorImportacion</a>
                        </li>
                        <li>
                                <a class="variable" href="#GestorImportacion.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#GestorImportacion.persistence_service">persistence_service</a>
                        </li>
                        <li>
                                <a class="variable" href="#GestorImportacion.curso_model">curso_model</a>
                        </li>
                        <li>
                                <a class="variable" href="#GestorImportacion.thread_proc">thread_proc</a>
                        </li>
                        <li>
                                <a class="variable" href="#GestorImportacion.worker_proc">worker_proc</a>
                        </li>
                        <li>
                                <a class="variable" href="#GestorImportacion.thread_save">thread_save</a>
                        </li>
                        <li>
                                <a class="variable" href="#GestorImportacion.worker_save">worker_save</a>
                        </li>
                        <li>
                                <a class="variable" href="#GestorImportacion.pd_save">pd_save</a>
                        </li>
                        <li>
                                <a class="variable" href="#GestorImportacion.reporte_errores">reporte_errores</a>
                        </li>
                        <li>
                                <a class="variable" href="#GestorImportacion.lista_omitidos">lista_omitidos</a>
                        </li>
                        <li>
                                <a class="function" href="#GestorImportacion.ejecutar">ejecutar</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../utilities.html">utilities</a><wbr>.importer_window    </h1>

                
                        <input id="mod-importer_window-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-importer_window-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="c1">#  Copyright (c) 2026 Fleer</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="c1">#  Permission is hereby granted, free of charge, to any person obtaining a copy</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="c1">#  of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="c1">#  in the Software without restriction, including without limitation the rights</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="c1">#  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="c1">#  copies of the Software, and to permit persons to whom the Software is</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="c1">#  furnished to do so, subject to the following conditions:</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="c1">#</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="c1">#  The above copyright notice and this permission notice shall be included in all</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="c1">#  copies or substantial portions of the Software.</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Set</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">PyQt6.QtCore</span><span class="w"> </span><span class="kn">import</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">QThread</span><span class="p">,</span> <span class="n">pyqtSignal</span><span class="p">,</span> <span class="n">Qt</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">PyQt6.QtWidgets</span><span class="w"> </span><span class="kn">import</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QInputDialog</span><span class="p">,</span> <span class="n">QProgressDialog</span><span class="p">,</span> <span class="n">QApplication</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="c1"># Componentes Propios</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">utilities.dialogos</span><span class="w"> </span><span class="kn">import</span> <span class="n">DialogoEntrada</span><span class="p">,</span> <span class="n">DialogoSeleccion</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.curso_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">CursoModel</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="c1"># Componentes de UI</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">utilities.mapping_dialog</span><span class="w"> </span><span class="kn">import</span> <span class="n">DialogoMapeoNotas</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">utilities.dialogos</span><span class="w"> </span><span class="kn">import</span> <span class="n">DialogoEsquemaEvaluacion</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">controllers.import_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExcelEngine</span><span class="p">,</span> <span class="n">Validator</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">services.persistence</span><span class="w"> </span><span class="kn">import</span> <span class="n">PersistenceService</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">database.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">RegistroImportado</span><span class="p">,</span> <span class="n">ResultadoProceso</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">utilities.sanitizer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sanitizer</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="k">class</span><span class="w"> </span><span class="nc">WorkerProcesamiento</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">    Hilo de trabajo (Worker) encargado del procesamiento pesado de lectura</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">    y validación del archivo Excel.</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>    <span class="n">finished</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>    <span class="n">error</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excel_path</span><span class="p">,</span> <span class="n">curso_obj</span><span class="p">,</span> <span class="n">mapa_cols_manual</span><span class="p">,</span> <span class="n">mapa_actividades</span><span class="p">,</span> <span class="n">esquema_ponderacion</span><span class="p">):</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">        Inicializa el worker con los parámetros necesarios para la validación.</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">        Args:</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">            excel_path (str): Ruta del archivo Excel.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">            curso_obj: Objeto del curso seleccionado.</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">            mapa_cols_manual (dict): Mapeo manual de columnas de datos personales.</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">            mapa_actividades (dict): Mapeo de columnas de Excel a evaluaciones del curso.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">            esquema_ponderacion (dict): Configuración de pesos de las evaluaciones.</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">excel_path</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">curso</span> <span class="o">=</span> <span class="n">curso_obj</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mapa_manual</span> <span class="o">=</span> <span class="n">mapa_cols_manual</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mapa_actividades</span> <span class="o">=</span> <span class="n">mapa_actividades</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">esquema_ponderacion</span> <span class="o">=</span> <span class="n">esquema_ponderacion</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span> <span class="o">=</span> <span class="n">PersistenceService</span><span class="p">()</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">        Ejecuta la lógica de carga, mapeo y validación de datos.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">        Emite señal &#39;finished&#39; con los resultados o &#39;error&#39; si falla.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">cargar_caches</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curso</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>            <span class="n">dict_aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">obtener_diccionario_aliases</span><span class="p">()</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>            <span class="n">engine</span> <span class="o">=</span> <span class="n">ExcelEngine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="o">.</span><span class="n">cargar</span><span class="p">():</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;No se pudo leer el archivo Excel.&quot;</span><span class="p">)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>                <span class="k">return</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapa_manual</span><span class="p">:</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>                <span class="n">engine</span><span class="o">.</span><span class="n">mapa_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapa_manual</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>            <span class="n">validator</span> <span class="o">=</span> <span class="n">Validator</span><span class="p">(</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>                <span class="n">engine</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">mapa_cols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curso</span><span class="p">,</span> <span class="n">dict_aliases</span><span class="p">,</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mapa_actividades</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">esquema_ponderacion</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>            <span class="p">)</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>            <span class="n">validos</span><span class="p">,</span> <span class="n">revision</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">procesar</span><span class="p">()</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">validos</span><span class="p">,</span> <span class="n">revision</span><span class="p">)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error interno en Worker: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="k">class</span><span class="w"> </span><span class="nc">WorkerGuardado</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">    Hilo de trabajo dedicado exclusivamente a la persistencia de datos en la base de datos</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">    para evitar congelar la interfaz gráfica.</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>    <span class="n">finished</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="n">ResultadoProceso</span><span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>    <span class="n">error</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">persistence_service</span><span class="p">,</span> <span class="n">lista_datos</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RegistroImportado</span><span class="p">],</span> <span class="n">curso_id</span><span class="p">):</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">        Inicializa el worker de guardado.</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">        Args:</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">            persistence_service (PersistenceService): Instancia del servicio de persistencia.</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">            lista_datos (List[RegistroImportado]): Lista de registros validados y listos para guardar.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">            curso_id (str): ID del curso destino.</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">persistence_service</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lista</span> <span class="o">=</span> <span class="n">lista_datos</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">curso_id</span> <span class="o">=</span> <span class="n">curso_id</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        Ejecuta el guardado por lotes llamando al servicio de persistencia.</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">guardar_lote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lista</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curso_id</span><span class="p">)</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="k">class</span><span class="w"> </span><span class="nc">GestorImportacion</span><span class="p">:</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">    Controlador principal que orquesta todo el flujo de importación de datos desde Excel.</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">    Maneja la UI de selección, mapeo de columnas, validación interactiva y guardado.</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_widget</span><span class="p">):</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">        Inicializa el gestor.</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">        Args:</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">            parent_widget (QWidget): Widget padre para mostrar diálogos modales.</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent_widget</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span> <span class="o">=</span> <span class="n">PersistenceService</span><span class="p">()</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">curso_model</span> <span class="o">=</span> <span class="n">CursoModel</span><span class="p">()</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reporte_errores</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lista_omitidos</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># NUEVO: Lista separada para los omitidos manualmente</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ejecutar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">        Inicia el asistente de importación paso a paso.</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reporte_errores</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lista_omitidos</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Reiniciar omitidos</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="c1"># 1. Selección Archivo</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="n">archivo</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Seleccionar Excel&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Excel Files (*.xlsx *.ods)&quot;</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">archivo</span><span class="p">:</span> <span class="k">return</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>        <span class="c1"># 2. Selección Curso</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>        <span class="n">cursos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curso_model</span><span class="o">.</span><span class="n">cursos_activos</span><span class="p">()</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cursos</span><span class="p">:</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Atención&quot;</span><span class="p">,</span> <span class="s2">&quot;No existen cursos activos.&quot;</span><span class="p">)</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>            <span class="k">return</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="n">nombres</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">nombre</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cursos</span><span class="p">]</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="n">sel_dialog</span> <span class="o">=</span> <span class="n">DialogoSeleccion</span><span class="p">(</span><span class="s2">&quot;Seleccionar Curso&quot;</span><span class="p">,</span> <span class="s2">&quot;Destino:&quot;</span><span class="p">,</span> <span class="n">nombres</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_dialog</span><span class="o">.</span><span class="n">exec</span><span class="p">():</span> <span class="k">return</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="n">nombre_curso</span> <span class="o">=</span> <span class="n">sel_dialog</span><span class="o">.</span><span class="n">obtener_seleccion</span><span class="p">()</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="n">curso_seleccionado</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cursos</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="n">nombre_curso</span><span class="p">)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="c1"># 3. Pre-validación Columnas</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="n">engine_pre</span> <span class="o">=</span> <span class="n">ExcelEngine</span><span class="p">(</span><span class="n">archivo</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">engine_pre</span><span class="o">.</span><span class="n">cargar</span><span class="p">():</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;Archivo corrupto.&quot;</span><span class="p">)</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>            <span class="k">return</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">resolver_ui</span><span class="p">(</span><span class="n">nombre</span><span class="p">,</span> <span class="n">opciones</span><span class="p">):</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="n">item</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Asignación Manual&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Falta &#39;</span><span class="si">{</span><span class="n">nombre</span><span class="si">}</span><span class="s2">&#39;:&quot;</span><span class="p">,</span> <span class="n">opciones</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>            <span class="k">return</span> <span class="n">item</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">engine_pre</span><span class="o">.</span><span class="n">mapear_columnas</span><span class="p">(</span><span class="n">manual_resolver_callback</span><span class="o">=</span><span class="n">resolver_ui</span><span class="p">):</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>            <span class="k">return</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="c1"># --- VERIFICACIÓN Y GESTIÓN DE ESQUEMA ---</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>        <span class="n">esquema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span><span class="o">.</span><span class="n">obtener_esquema_curso</span><span class="p">(</span><span class="n">curso_seleccionado</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="c1"># Si NO hay esquema, ofrecemos crearlo</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">esquema</span><span class="p">:</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>            <span class="n">resp_crear</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Sistema de Evaluación Faltante&quot;</span><span class="p">,</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>                <span class="sa">f</span><span class="s2">&quot;El curso &#39;</span><span class="si">{</span><span class="n">curso_seleccionado</span><span class="o">.</span><span class="n">nombre</span><span class="si">}</span><span class="s2">&#39; no tiene configurado un sistema de evaluación.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>                <span class="s2">&quot;¿Desea configurarlo AHORA para poder importar las notas del Excel?&quot;</span><span class="p">,</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>            <span class="p">)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>            <span class="k">if</span> <span class="n">resp_crear</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>                <span class="n">dlg_esquema</span> <span class="o">=</span> <span class="n">DialogoEsquemaEvaluacion</span><span class="p">(</span><span class="n">curso_seleccionado</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>                <span class="n">dlg_esquema</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>                <span class="n">esquema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span><span class="o">.</span><span class="n">obtener_esquema_curso</span><span class="p">(</span><span class="n">curso_seleccionado</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>        <span class="c1"># Preparamos variables</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="n">mapa_actividades</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="n">esquema_ponderacion</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="k">if</span> <span class="n">esquema</span><span class="p">:</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>            <span class="n">esquema_ponderacion</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;porcentaje&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">esquema</span><span class="p">}</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>            <span class="n">columnas_disponibles</span> <span class="o">=</span> <span class="n">engine_pre</span><span class="o">.</span><span class="n">obtener_columnas_restantes</span><span class="p">()</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>            <span class="n">dialogo_mapeo</span> <span class="o">=</span> <span class="n">DialogoMapeoNotas</span><span class="p">(</span><span class="n">columnas_disponibles</span><span class="p">,</span> <span class="n">esquema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dialogo_mapeo</span><span class="o">.</span><span class="n">exec</span><span class="p">():</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>                <span class="k">return</span>  <span class="c1"># Cancelado en mapeo</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="n">mapa_actividades</span> <span class="o">=</span> <span class="n">dialogo_mapeo</span><span class="o">.</span><span class="n">obtener_mapeo</span><span class="p">()</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">mapa_actividades</span><span class="p">:</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Info&quot;</span><span class="p">,</span> <span class="s2">&quot;No vinculó columnas. Se importarán solo datos personales.&quot;</span><span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>            <span class="n">resp_final</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Importación Parcial&quot;</span><span class="p">,</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>                <span class="s2">&quot;⚠️ No hay esquema de evaluación.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>                <span class="s2">&quot;Se importarán SOLO los estudiantes y matrículas (Sin Calificaciones).</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>                <span class="s2">&quot;¿Desea continuar?&quot;</span><span class="p">,</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>            <span class="p">)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>            <span class="k">if</span> <span class="n">resp_final</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span><span class="p">:</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>                <span class="k">return</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="c1"># 4. Iniciar Worker</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span> <span class="o">=</span> <span class="n">WorkerProcesamiento</span><span class="p">(</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>            <span class="n">archivo</span><span class="p">,</span> <span class="n">curso_seleccionado</span><span class="p">,</span> <span class="n">engine_pre</span><span class="o">.</span><span class="n">mapa_cols</span><span class="p">,</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>            <span class="n">mapa_actividades</span><span class="p">,</span> <span class="n">esquema_ponderacion</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>        <span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_al_terminar_analisis</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">curso_seleccionado</span><span class="p">))</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">quit</span><span class="p">)</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_al_terminar_analisis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validos</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RegistroImportado</span><span class="p">],</span> <span class="n">revision</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RegistroImportado</span><span class="p">],</span> <span class="n">curso</span><span class="p">):</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">        Callback ejecutado cuando termina el análisis del Excel.</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">        Maneja la deduplicación, revisión interactiva y lanza el proceso de guardado.</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">validos</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">revision</span><span class="p">:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Finalizado&quot;</span><span class="p">,</span> <span class="s2">&quot;No se encontraron registros válidos.&quot;</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>            <span class="k">return</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span><span class="o">.</span><span class="n">cargar_caches</span><span class="p">(</span><span class="n">curso</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>        <span class="c1"># --- FASE 1: DEDUPLICACIÓN ---</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>        <span class="n">mapa_maestro</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RegistroImportado</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">validos</span><span class="p">:</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>            <span class="k">if</span> <span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span> <span class="ow">in</span> <span class="n">mapa_maestro</span><span class="p">:</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>                <span class="n">anterior</span> <span class="o">=</span> <span class="n">mapa_maestro</span><span class="p">[</span><span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span><span class="p">]</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reporte_errores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duplicado interno: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span><span class="si">}</span><span class="s2"> (Se usa fila </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">fila_excel</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>            <span class="n">mapa_maestro</span><span class="p">[</span><span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>        <span class="c1"># --- FASE 2: RESOLUCIÓN ---</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="n">corregidos</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="k">if</span> <span class="n">revision</span><span class="p">:</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="n">corregidos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolver_revisiones_interactivas</span><span class="p">(</span><span class="n">revision</span><span class="p">,</span> <span class="n">mapa_maestro</span><span class="p">)</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">corregidos</span><span class="p">:</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>            <span class="n">mapa_maestro</span><span class="p">[</span><span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>        <span class="n">lista_final_unica</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapa_maestro</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">lista_final_unica</span><span class="p">:</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Cancelado&quot;</span><span class="p">,</span> <span class="s2">&quot;No hay registros para guardar.&quot;</span><span class="p">)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>            <span class="k">return</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>        <span class="c1"># Guardado</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span> <span class="o">=</span> <span class="n">QProgressDialog</span><span class="p">(</span><span class="s2">&quot;Guardando en Base de Datos...&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Finalizando&quot;</span><span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="o">.</span><span class="n">setWindowModality</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowModality</span><span class="o">.</span><span class="n">WindowModal</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="o">.</span><span class="n">setCancelButton</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span> <span class="o">=</span> <span class="n">WorkerGuardado</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span><span class="p">,</span> <span class="n">lista_final_unica</span><span class="p">,</span> <span class="n">curso</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span><span class="p">)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_guardado_finished</span><span class="p">)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_guardado_error</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span><span class="o">.</span><span class="n">quit</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_guardado_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultado</span><span class="p">:</span> <span class="n">ResultadoProceso</span><span class="p">):</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback al finalizar el guardado en BD.&quot;&quot;&quot;</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>        <span class="c1"># Le sumamos los omitidos manualmente durante la fase de revisión</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>        <span class="n">resultado</span><span class="o">.</span><span class="n">registros_omitidos</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lista_omitidos</span><span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mostrar_resumen</span><span class="p">(</span><span class="n">resultado</span><span class="p">)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_guardado_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">):</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback si ocurre un error crítico durante el guardado.&quot;&quot;&quot;</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Error de Guardado&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Ocurrió un error al guardar:</span><span class="se">\n</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>    <span class="c1"># --- Lógica de Revisión Interactiva ---</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_resolver_revisiones_interactivas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lista_revision</span><span class="p">,</span> <span class="n">mapa_validos</span><span class="p">):</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="sd">        Itera sobre registros problemáticos y solicita intervención del usuario</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="sd">        para corregir cédulas o resolver conflictos de duplicados.</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="n">aceptados</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="n">mapa_aceptados</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lista_revision</span><span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lista_revision</span><span class="p">):</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>                <span class="n">dialog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crear_dialogo_revision</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">dialog</span><span class="o">.</span><span class="n">exec</span><span class="p">():</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confirmar_omision</span><span class="p">(</span><span class="n">reg</span><span class="p">):</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_registrar_omision</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                        <span class="k">break</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                    <span class="k">continue</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                <span class="n">nueva_ced</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">obtener_dato</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">Sanitizer</span><span class="o">.</span><span class="n">validar_cedula_ecuador</span><span class="p">(</span><span class="n">nueva_ced</span><span class="p">):</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                    <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;Cédula inválida.&quot;</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                    <span class="k">continue</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                <span class="k">if</span> <span class="n">nueva_ced</span> <span class="ow">in</span> <span class="n">mapa_aceptados</span><span class="p">:</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                    <span class="n">dup</span> <span class="o">=</span> <span class="n">mapa_aceptados</span><span class="p">[</span><span class="n">nueva_ced</span><span class="p">]</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                    <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Duplicado&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Ya asignada a </span><span class="si">{</span><span class="n">dup</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                    <span class="k">continue</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                <span class="k">if</span> <span class="n">nueva_ced</span> <span class="ow">in</span> <span class="n">mapa_validos</span><span class="p">:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                    <span class="n">dup</span> <span class="o">=</span> <span class="n">mapa_validos</span><span class="p">[</span><span class="n">nueva_ced</span><span class="p">]</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CONFLICTO INTERNO: La cédula </span><span class="si">{</span><span class="n">nueva_ced</span><span class="si">}</span><span class="s2"> ya existe en el archivo.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                           <span class="sa">f</span><span class="s2">&quot;🟦 REGISTRO EXISTENTE (Fila </span><span class="si">{</span><span class="n">dup</span><span class="o">.</span><span class="n">fila_excel</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>                           <span class="sa">f</span><span class="s2">&quot;   Nombre: </span><span class="si">{</span><span class="n">dup</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>                           <span class="sa">f</span><span class="s2">&quot;   Nota Final: </span><span class="si">{</span><span class="n">dup</span><span class="o">.</span><span class="n">nota_final</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">dup</span><span class="o">.</span><span class="n">estado_sugerido</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>                           <span class="sa">f</span><span class="s2">&quot;🟧 REGISTRO ACTUAL (Manual):</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>                           <span class="sa">f</span><span class="s2">&quot;   Nombre: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>                           <span class="sa">f</span><span class="s2">&quot;   Nota Final: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nota_final</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">estado_sugerido</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>                           <span class="sa">f</span><span class="s2">&quot;¿Qué registro desea conservar?&quot;</span><span class="p">)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>                    <span class="n">box</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>                    <span class="n">box</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Conflicto de Datos&quot;</span><span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>                    <span class="n">box</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>                    <span class="n">box</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="s2">&quot;Mantener Existente&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">ButtonRole</span><span class="o">.</span><span class="n">ActionRole</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>                    <span class="n">btn_act</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="s2">&quot;Sobrescribir con Actual&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">ButtonRole</span><span class="o">.</span><span class="n">ActionRole</span><span class="p">)</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                    <span class="n">box</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="s2">&quot;Cancelar&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">ButtonRole</span><span class="o">.</span><span class="n">RejectRole</span><span class="p">)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>                    <span class="n">box</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>                    <span class="n">clicked</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">clickedButton</span><span class="p">()</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>                    <span class="k">if</span> <span class="n">clicked</span> <span class="o">==</span> <span class="n">btn_act</span><span class="p">:</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>                        <span class="k">pass</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>                    <span class="k">elif</span> <span class="n">clicked</span> <span class="o">==</span> <span class="n">box</span><span class="o">.</span><span class="n">buttons</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">reporte_errores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>                            <span class="sa">f</span><span class="s2">&quot;Fusión: Se descartó </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="s2"> en favor de existente </span><span class="si">{</span><span class="n">dup</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                        <span class="c1"># Esto podría contarse como omisión técnica o fusión</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                        <span class="k">break</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>                        <span class="k">continue</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validar_existencia_bd</span><span class="p">(</span><span class="n">nueva_ced</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                    <span class="k">continue</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>                <span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span> <span class="o">=</span> <span class="n">nueva_ced</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>                <span class="n">aceptados</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                <span class="n">mapa_aceptados</span><span class="p">[</span><span class="n">nueva_ced</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>                <span class="k">break</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>        <span class="k">return</span> <span class="n">aceptados</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_crear_dialogo_revision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Crea y configura el diálogo de corrección de cédula.&quot;&quot;&quot;</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estudiante: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="se">\n</span><span class="s2">Centro: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">centro_nombre</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>               <span class="sa">f</span><span class="s2">&quot;Problema: Cédula &#39;</span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">cedula_original</span><span class="si">}</span><span class="s2">&#39; inválida.</span><span class="se">\n</span><span class="s2">Ingrese la correcta:&quot;</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>        <span class="n">val</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span> <span class="ow">or</span> <span class="n">reg</span><span class="o">.</span><span class="n">cedula_original</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>        <span class="k">return</span> <span class="n">DialogoEntrada</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Revisión (</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_confirmar_omision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Pregunta al usuario si desea descartar definitivamente un registro.&quot;&quot;&quot;</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="k">return</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Omitir&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;¿Omitir a </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="s2">?&quot;</span><span class="p">,</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>                                    <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span><span class="p">)</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_registrar_omision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Registra un registro omitido en las listas de control y reportes.&quot;&quot;&quot;</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>        <span class="c1"># Ahora registramos en lista específica Y en errores para el log</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lista_omitidos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reporte_errores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Omitido por usuario: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="s2"> (Cédula: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">cedula_original</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validar_existencia_bd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cedula</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">        Verifica si la cédula ya existe en la base de datos y pregunta al usuario</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">        si desea fusionar los datos.</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="n">est_bd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span><span class="o">.</span><span class="n">cache_estudiantes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cedula</span><span class="p">)</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        <span class="k">if</span> <span class="n">est_bd</span><span class="p">:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;La cédula </span><span class="si">{</span><span class="n">cedula</span><span class="si">}</span><span class="s2"> existe en BD:</span><span class="se">\n</span><span class="si">{</span><span class="n">est_bd</span><span class="o">.</span><span class="n">nombre</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                   <span class="sa">f</span><span class="s2">&quot;¿FUSIONAR con el registro actual (</span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="s2">)?</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                   <span class="sa">f</span><span class="s2">&quot;ℹ️ IMPLICACIÓN: Se asignarán la matrícula y notas de este Excel al estudiante existente (</span><span class="si">{</span><span class="n">est_bd</span><span class="o">.</span><span class="n">nombre</span><span class="si">}</span><span class="s2">), &quot;</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                   <span class="sa">f</span><span class="s2">&quot;ignorando el nombre mal escrito que aparece en el archivo.&quot;</span><span class="p">)</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>            <span class="k">return</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Existente en BD&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                                        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span><span class="p">)</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_mostrar_resumen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultado</span><span class="p">):</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Muestra el diálogo final con las estadísticas del proceso.&quot;&quot;&quot;</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="c1"># Mensaje con formato detallado y viñetas</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>            <span class="s2">&quot;&lt;b&gt;Proceso de Importación Finalizado&lt;/b&gt;&quot;</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;b&gt;Proceso de Importación Finalizado&lt;/b&gt;&lt;br&gt;&lt;br&gt;</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="s2">                &lt;b&gt;Nuevos Estudiantes:&lt;/b&gt; </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">nuevos_estudiantes</span><span class="si">}</span><span class="s2">&lt;br&gt;</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="s2">                &lt;b&gt;Matrículas Nuevas (Inscripciones):&lt;/b&gt; </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">matriculas_nuevas</span><span class="si">}</span><span class="s2">&lt;br&gt;</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a><span class="s2">                &lt;b&gt;Matrículas Actualizadas (Notas):&lt;/b&gt; </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">matriculas_actualizadas</span><span class="si">}</span><span class="s2">&lt;br&gt;</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="s2">                &lt;b&gt;Registros Omitidos:&lt;/b&gt; &lt;span style=&quot;color:red&quot;&gt;</span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">registros_omitidos</span><span class="si">}</span><span class="s2">&lt;/span&gt;&lt;br&gt;&lt;br&gt;</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="s2">                &lt;i&gt;Errores técnicos: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">resultado</span><span class="o">.</span><span class="n">errores</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/i&gt;&quot;&quot;&quot;</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>        <span class="p">)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>        <span class="n">box</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>        <span class="n">box</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Resumen de Importación&quot;</span><span class="p">)</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>        <span class="n">box</span><span class="o">.</span><span class="n">setTextFormat</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">TextFormat</span><span class="o">.</span><span class="n">RichText</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>        <span class="n">box</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>        <span class="n">btn_ok</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="s2">&quot;Aceptar&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">ButtonRole</span><span class="o">.</span><span class="n">AcceptRole</span><span class="p">)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="n">btn_log</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>        <span class="k">if</span> <span class="n">resultado</span><span class="o">.</span><span class="n">errores</span> <span class="ow">or</span> <span class="n">resultado</span><span class="o">.</span><span class="n">registros_omitidos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>            <span class="n">box</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;&lt;br&gt;&lt;br&gt;¿Desea guardar el log de errores/omisiones?&quot;</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>            <span class="n">btn_log</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="s2">&quot;Guardar Log&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">ButtonRole</span><span class="o">.</span><span class="n">ActionRole</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="n">box</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">clickedButton</span><span class="p">()</span> <span class="o">==</span> <span class="n">btn_log</span><span class="p">:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_guardar_log</span><span class="p">(</span><span class="n">resultado</span><span class="o">.</span><span class="n">errores</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;actualizar_cache_global&#39;</span><span class="p">):</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">actualizar_cache_global</span><span class="p">()</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;cargar_datos_tabla&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cargar_datos_tabla</span><span class="p">()</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;cargar_datos_tabla_cursos&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cargar_datos_tabla_cursos</span><span class="p">()</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_guardar_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errores</span><span class="p">):</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Guarda el archivo de texto con el log de errores.&quot;&quot;&quot;</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="n">ruta</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>            <span class="s2">&quot;Guardar Log&quot;</span><span class="p">,</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>            <span class="sa">f</span><span class="s2">&quot;log_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.txt&quot;</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>        <span class="p">)</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="k">if</span> <span class="n">ruta</span><span class="p">:</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ruta</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=== LOG DE ERRORES Y OMISIONES ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errores</span><span class="p">))</span>
</span></pre></div>


            </section>
                <section id="WorkerProcesamiento">
                            <input id="WorkerProcesamiento-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">WorkerProcesamiento</span><wbr>(<span class="base">PyQt6.QtCore.QObject</span>):

                <label class="view-source-button" for="WorkerProcesamiento-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WorkerProcesamiento"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WorkerProcesamiento-32"><a href="#WorkerProcesamiento-32"><span class="linenos">32</span></a><span class="k">class</span><span class="w"> </span><span class="nc">WorkerProcesamiento</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
</span><span id="WorkerProcesamiento-33"><a href="#WorkerProcesamiento-33"><span class="linenos">33</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="WorkerProcesamiento-34"><a href="#WorkerProcesamiento-34"><span class="linenos">34</span></a><span class="sd">    Hilo de trabajo (Worker) encargado del procesamiento pesado de lectura</span>
</span><span id="WorkerProcesamiento-35"><a href="#WorkerProcesamiento-35"><span class="linenos">35</span></a><span class="sd">    y validación del archivo Excel.</span>
</span><span id="WorkerProcesamiento-36"><a href="#WorkerProcesamiento-36"><span class="linenos">36</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="WorkerProcesamiento-37"><a href="#WorkerProcesamiento-37"><span class="linenos">37</span></a>    <span class="n">finished</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
</span><span id="WorkerProcesamiento-38"><a href="#WorkerProcesamiento-38"><span class="linenos">38</span></a>    <span class="n">error</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="WorkerProcesamiento-39"><a href="#WorkerProcesamiento-39"><span class="linenos">39</span></a>
</span><span id="WorkerProcesamiento-40"><a href="#WorkerProcesamiento-40"><span class="linenos">40</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excel_path</span><span class="p">,</span> <span class="n">curso_obj</span><span class="p">,</span> <span class="n">mapa_cols_manual</span><span class="p">,</span> <span class="n">mapa_actividades</span><span class="p">,</span> <span class="n">esquema_ponderacion</span><span class="p">):</span>
</span><span id="WorkerProcesamiento-41"><a href="#WorkerProcesamiento-41"><span class="linenos">41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="WorkerProcesamiento-42"><a href="#WorkerProcesamiento-42"><span class="linenos">42</span></a><span class="sd">        Inicializa el worker con los parámetros necesarios para la validación.</span>
</span><span id="WorkerProcesamiento-43"><a href="#WorkerProcesamiento-43"><span class="linenos">43</span></a>
</span><span id="WorkerProcesamiento-44"><a href="#WorkerProcesamiento-44"><span class="linenos">44</span></a><span class="sd">        Args:</span>
</span><span id="WorkerProcesamiento-45"><a href="#WorkerProcesamiento-45"><span class="linenos">45</span></a><span class="sd">            excel_path (str): Ruta del archivo Excel.</span>
</span><span id="WorkerProcesamiento-46"><a href="#WorkerProcesamiento-46"><span class="linenos">46</span></a><span class="sd">            curso_obj: Objeto del curso seleccionado.</span>
</span><span id="WorkerProcesamiento-47"><a href="#WorkerProcesamiento-47"><span class="linenos">47</span></a><span class="sd">            mapa_cols_manual (dict): Mapeo manual de columnas de datos personales.</span>
</span><span id="WorkerProcesamiento-48"><a href="#WorkerProcesamiento-48"><span class="linenos">48</span></a><span class="sd">            mapa_actividades (dict): Mapeo de columnas de Excel a evaluaciones del curso.</span>
</span><span id="WorkerProcesamiento-49"><a href="#WorkerProcesamiento-49"><span class="linenos">49</span></a><span class="sd">            esquema_ponderacion (dict): Configuración de pesos de las evaluaciones.</span>
</span><span id="WorkerProcesamiento-50"><a href="#WorkerProcesamiento-50"><span class="linenos">50</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorkerProcesamiento-51"><a href="#WorkerProcesamiento-51"><span class="linenos">51</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="WorkerProcesamiento-52"><a href="#WorkerProcesamiento-52"><span class="linenos">52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">excel_path</span>
</span><span id="WorkerProcesamiento-53"><a href="#WorkerProcesamiento-53"><span class="linenos">53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">curso</span> <span class="o">=</span> <span class="n">curso_obj</span>
</span><span id="WorkerProcesamiento-54"><a href="#WorkerProcesamiento-54"><span class="linenos">54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mapa_manual</span> <span class="o">=</span> <span class="n">mapa_cols_manual</span>
</span><span id="WorkerProcesamiento-55"><a href="#WorkerProcesamiento-55"><span class="linenos">55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mapa_actividades</span> <span class="o">=</span> <span class="n">mapa_actividades</span>
</span><span id="WorkerProcesamiento-56"><a href="#WorkerProcesamiento-56"><span class="linenos">56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">esquema_ponderacion</span> <span class="o">=</span> <span class="n">esquema_ponderacion</span>
</span><span id="WorkerProcesamiento-57"><a href="#WorkerProcesamiento-57"><span class="linenos">57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span> <span class="o">=</span> <span class="n">PersistenceService</span><span class="p">()</span>
</span><span id="WorkerProcesamiento-58"><a href="#WorkerProcesamiento-58"><span class="linenos">58</span></a>
</span><span id="WorkerProcesamiento-59"><a href="#WorkerProcesamiento-59"><span class="linenos">59</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="WorkerProcesamiento-60"><a href="#WorkerProcesamiento-60"><span class="linenos">60</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="WorkerProcesamiento-61"><a href="#WorkerProcesamiento-61"><span class="linenos">61</span></a><span class="sd">        Ejecuta la lógica de carga, mapeo y validación de datos.</span>
</span><span id="WorkerProcesamiento-62"><a href="#WorkerProcesamiento-62"><span class="linenos">62</span></a><span class="sd">        Emite señal &#39;finished&#39; con los resultados o &#39;error&#39; si falla.</span>
</span><span id="WorkerProcesamiento-63"><a href="#WorkerProcesamiento-63"><span class="linenos">63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorkerProcesamiento-64"><a href="#WorkerProcesamiento-64"><span class="linenos">64</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="WorkerProcesamiento-65"><a href="#WorkerProcesamiento-65"><span class="linenos">65</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">cargar_caches</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curso</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="WorkerProcesamiento-66"><a href="#WorkerProcesamiento-66"><span class="linenos">66</span></a>            <span class="n">dict_aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">obtener_diccionario_aliases</span><span class="p">()</span>
</span><span id="WorkerProcesamiento-67"><a href="#WorkerProcesamiento-67"><span class="linenos">67</span></a>
</span><span id="WorkerProcesamiento-68"><a href="#WorkerProcesamiento-68"><span class="linenos">68</span></a>            <span class="n">engine</span> <span class="o">=</span> <span class="n">ExcelEngine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</span><span id="WorkerProcesamiento-69"><a href="#WorkerProcesamiento-69"><span class="linenos">69</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="o">.</span><span class="n">cargar</span><span class="p">():</span>
</span><span id="WorkerProcesamiento-70"><a href="#WorkerProcesamiento-70"><span class="linenos">70</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;No se pudo leer el archivo Excel.&quot;</span><span class="p">)</span>
</span><span id="WorkerProcesamiento-71"><a href="#WorkerProcesamiento-71"><span class="linenos">71</span></a>                <span class="k">return</span>
</span><span id="WorkerProcesamiento-72"><a href="#WorkerProcesamiento-72"><span class="linenos">72</span></a>
</span><span id="WorkerProcesamiento-73"><a href="#WorkerProcesamiento-73"><span class="linenos">73</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapa_manual</span><span class="p">:</span>
</span><span id="WorkerProcesamiento-74"><a href="#WorkerProcesamiento-74"><span class="linenos">74</span></a>                <span class="n">engine</span><span class="o">.</span><span class="n">mapa_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapa_manual</span>
</span><span id="WorkerProcesamiento-75"><a href="#WorkerProcesamiento-75"><span class="linenos">75</span></a>
</span><span id="WorkerProcesamiento-76"><a href="#WorkerProcesamiento-76"><span class="linenos">76</span></a>            <span class="n">validator</span> <span class="o">=</span> <span class="n">Validator</span><span class="p">(</span>
</span><span id="WorkerProcesamiento-77"><a href="#WorkerProcesamiento-77"><span class="linenos">77</span></a>                <span class="n">engine</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">mapa_cols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curso</span><span class="p">,</span> <span class="n">dict_aliases</span><span class="p">,</span>
</span><span id="WorkerProcesamiento-78"><a href="#WorkerProcesamiento-78"><span class="linenos">78</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mapa_actividades</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">esquema_ponderacion</span>
</span><span id="WorkerProcesamiento-79"><a href="#WorkerProcesamiento-79"><span class="linenos">79</span></a>            <span class="p">)</span>
</span><span id="WorkerProcesamiento-80"><a href="#WorkerProcesamiento-80"><span class="linenos">80</span></a>            <span class="n">validos</span><span class="p">,</span> <span class="n">revision</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">procesar</span><span class="p">()</span>
</span><span id="WorkerProcesamiento-81"><a href="#WorkerProcesamiento-81"><span class="linenos">81</span></a>
</span><span id="WorkerProcesamiento-82"><a href="#WorkerProcesamiento-82"><span class="linenos">82</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">validos</span><span class="p">,</span> <span class="n">revision</span><span class="p">)</span>
</span><span id="WorkerProcesamiento-83"><a href="#WorkerProcesamiento-83"><span class="linenos">83</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorkerProcesamiento-84"><a href="#WorkerProcesamiento-84"><span class="linenos">84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error interno en Worker: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Hilo de trabajo (Worker) encargado del procesamiento pesado de lectura
y validación del archivo Excel.</p>
</div>


                            <div id="WorkerProcesamiento.__init__" class="classattr">
                                        <input id="WorkerProcesamiento.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">WorkerProcesamiento</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">excel_path</span>,</span><span class="param">	<span class="n">curso_obj</span>,</span><span class="param">	<span class="n">mapa_cols_manual</span>,</span><span class="param">	<span class="n">mapa_actividades</span>,</span><span class="param">	<span class="n">esquema_ponderacion</span></span>)</span>

                <label class="view-source-button" for="WorkerProcesamiento.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WorkerProcesamiento.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WorkerProcesamiento.__init__-40"><a href="#WorkerProcesamiento.__init__-40"><span class="linenos">40</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excel_path</span><span class="p">,</span> <span class="n">curso_obj</span><span class="p">,</span> <span class="n">mapa_cols_manual</span><span class="p">,</span> <span class="n">mapa_actividades</span><span class="p">,</span> <span class="n">esquema_ponderacion</span><span class="p">):</span>
</span><span id="WorkerProcesamiento.__init__-41"><a href="#WorkerProcesamiento.__init__-41"><span class="linenos">41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="WorkerProcesamiento.__init__-42"><a href="#WorkerProcesamiento.__init__-42"><span class="linenos">42</span></a><span class="sd">        Inicializa el worker con los parámetros necesarios para la validación.</span>
</span><span id="WorkerProcesamiento.__init__-43"><a href="#WorkerProcesamiento.__init__-43"><span class="linenos">43</span></a>
</span><span id="WorkerProcesamiento.__init__-44"><a href="#WorkerProcesamiento.__init__-44"><span class="linenos">44</span></a><span class="sd">        Args:</span>
</span><span id="WorkerProcesamiento.__init__-45"><a href="#WorkerProcesamiento.__init__-45"><span class="linenos">45</span></a><span class="sd">            excel_path (str): Ruta del archivo Excel.</span>
</span><span id="WorkerProcesamiento.__init__-46"><a href="#WorkerProcesamiento.__init__-46"><span class="linenos">46</span></a><span class="sd">            curso_obj: Objeto del curso seleccionado.</span>
</span><span id="WorkerProcesamiento.__init__-47"><a href="#WorkerProcesamiento.__init__-47"><span class="linenos">47</span></a><span class="sd">            mapa_cols_manual (dict): Mapeo manual de columnas de datos personales.</span>
</span><span id="WorkerProcesamiento.__init__-48"><a href="#WorkerProcesamiento.__init__-48"><span class="linenos">48</span></a><span class="sd">            mapa_actividades (dict): Mapeo de columnas de Excel a evaluaciones del curso.</span>
</span><span id="WorkerProcesamiento.__init__-49"><a href="#WorkerProcesamiento.__init__-49"><span class="linenos">49</span></a><span class="sd">            esquema_ponderacion (dict): Configuración de pesos de las evaluaciones.</span>
</span><span id="WorkerProcesamiento.__init__-50"><a href="#WorkerProcesamiento.__init__-50"><span class="linenos">50</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorkerProcesamiento.__init__-51"><a href="#WorkerProcesamiento.__init__-51"><span class="linenos">51</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="WorkerProcesamiento.__init__-52"><a href="#WorkerProcesamiento.__init__-52"><span class="linenos">52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">excel_path</span>
</span><span id="WorkerProcesamiento.__init__-53"><a href="#WorkerProcesamiento.__init__-53"><span class="linenos">53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">curso</span> <span class="o">=</span> <span class="n">curso_obj</span>
</span><span id="WorkerProcesamiento.__init__-54"><a href="#WorkerProcesamiento.__init__-54"><span class="linenos">54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mapa_manual</span> <span class="o">=</span> <span class="n">mapa_cols_manual</span>
</span><span id="WorkerProcesamiento.__init__-55"><a href="#WorkerProcesamiento.__init__-55"><span class="linenos">55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mapa_actividades</span> <span class="o">=</span> <span class="n">mapa_actividades</span>
</span><span id="WorkerProcesamiento.__init__-56"><a href="#WorkerProcesamiento.__init__-56"><span class="linenos">56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">esquema_ponderacion</span> <span class="o">=</span> <span class="n">esquema_ponderacion</span>
</span><span id="WorkerProcesamiento.__init__-57"><a href="#WorkerProcesamiento.__init__-57"><span class="linenos">57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span> <span class="o">=</span> <span class="n">PersistenceService</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Inicializa el worker con los parámetros necesarios para la validación.</p>

<p>Args:
    excel_path (str): Ruta del archivo Excel.
    curso_obj: Objeto del curso seleccionado.
    mapa_cols_manual (dict): Mapeo manual de columnas de datos personales.
    mapa_actividades (dict): Mapeo de columnas de Excel a evaluaciones del curso.
    esquema_ponderacion (dict): Configuración de pesos de las evaluaciones.</p>
</div>


                            </div>
                            <div id="WorkerProcesamiento.finished" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">finished</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#WorkerProcesamiento.finished"></a>
    
            <div class="docstring"><p>pyqtSignal(*types, name: str = ..., revision: int = ..., arguments: Sequence = ...) -> PYQT_SIGNAL</p>

<p>types is normally a sequence of individual types.  Each type is either a
type object or a string that is the name of a C++ type.  Alternatively
each type could itself be a sequence of types each describing a different
overloaded signal.
name is the optional C++ name of the signal.  If it is not specified then
the name of the class attribute that is bound to the signal is used.
revision is the optional revision of the signal that is exported to QML.
If it is not specified then 0 is used.
arguments is the optional sequence of the names of the signal's arguments.</p>
</div>


                            </div>
                            <div id="WorkerProcesamiento.error" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">error</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#WorkerProcesamiento.error"></a>
    
            <div class="docstring"><p>pyqtSignal(*types, name: str = ..., revision: int = ..., arguments: Sequence = ...) -> PYQT_SIGNAL</p>

<p>types is normally a sequence of individual types.  Each type is either a
type object or a string that is the name of a C++ type.  Alternatively
each type could itself be a sequence of types each describing a different
overloaded signal.
name is the optional C++ name of the signal.  If it is not specified then
the name of the class attribute that is bound to the signal is used.
revision is the optional revision of the signal that is exported to QML.
If it is not specified then 0 is used.
arguments is the optional sequence of the names of the signal's arguments.</p>
</div>


                            </div>
                            <div id="WorkerProcesamiento.path" class="classattr">
                                <div class="attr variable">
            <span class="name">path</span>

        
    </div>
    <a class="headerlink" href="#WorkerProcesamiento.path"></a>
    
    

                            </div>
                            <div id="WorkerProcesamiento.curso" class="classattr">
                                <div class="attr variable">
            <span class="name">curso</span>

        
    </div>
    <a class="headerlink" href="#WorkerProcesamiento.curso"></a>
    
    

                            </div>
                            <div id="WorkerProcesamiento.mapa_manual" class="classattr">
                                <div class="attr variable">
            <span class="name">mapa_manual</span>

        
    </div>
    <a class="headerlink" href="#WorkerProcesamiento.mapa_manual"></a>
    
    

                            </div>
                            <div id="WorkerProcesamiento.mapa_actividades" class="classattr">
                                <div class="attr variable">
            <span class="name">mapa_actividades</span>

        
    </div>
    <a class="headerlink" href="#WorkerProcesamiento.mapa_actividades"></a>
    
    

                            </div>
                            <div id="WorkerProcesamiento.esquema_ponderacion" class="classattr">
                                <div class="attr variable">
            <span class="name">esquema_ponderacion</span>

        
    </div>
    <a class="headerlink" href="#WorkerProcesamiento.esquema_ponderacion"></a>
    
    

                            </div>
                            <div id="WorkerProcesamiento.persistence" class="classattr">
                                <div class="attr variable">
            <span class="name">persistence</span>

        
    </div>
    <a class="headerlink" href="#WorkerProcesamiento.persistence"></a>
    
    

                            </div>
                            <div id="WorkerProcesamiento.run" class="classattr">
                                        <input id="WorkerProcesamiento.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="WorkerProcesamiento.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WorkerProcesamiento.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WorkerProcesamiento.run-59"><a href="#WorkerProcesamiento.run-59"><span class="linenos">59</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="WorkerProcesamiento.run-60"><a href="#WorkerProcesamiento.run-60"><span class="linenos">60</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="WorkerProcesamiento.run-61"><a href="#WorkerProcesamiento.run-61"><span class="linenos">61</span></a><span class="sd">        Ejecuta la lógica de carga, mapeo y validación de datos.</span>
</span><span id="WorkerProcesamiento.run-62"><a href="#WorkerProcesamiento.run-62"><span class="linenos">62</span></a><span class="sd">        Emite señal &#39;finished&#39; con los resultados o &#39;error&#39; si falla.</span>
</span><span id="WorkerProcesamiento.run-63"><a href="#WorkerProcesamiento.run-63"><span class="linenos">63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorkerProcesamiento.run-64"><a href="#WorkerProcesamiento.run-64"><span class="linenos">64</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="WorkerProcesamiento.run-65"><a href="#WorkerProcesamiento.run-65"><span class="linenos">65</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">cargar_caches</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curso</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="WorkerProcesamiento.run-66"><a href="#WorkerProcesamiento.run-66"><span class="linenos">66</span></a>            <span class="n">dict_aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">obtener_diccionario_aliases</span><span class="p">()</span>
</span><span id="WorkerProcesamiento.run-67"><a href="#WorkerProcesamiento.run-67"><span class="linenos">67</span></a>
</span><span id="WorkerProcesamiento.run-68"><a href="#WorkerProcesamiento.run-68"><span class="linenos">68</span></a>            <span class="n">engine</span> <span class="o">=</span> <span class="n">ExcelEngine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</span><span id="WorkerProcesamiento.run-69"><a href="#WorkerProcesamiento.run-69"><span class="linenos">69</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="o">.</span><span class="n">cargar</span><span class="p">():</span>
</span><span id="WorkerProcesamiento.run-70"><a href="#WorkerProcesamiento.run-70"><span class="linenos">70</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;No se pudo leer el archivo Excel.&quot;</span><span class="p">)</span>
</span><span id="WorkerProcesamiento.run-71"><a href="#WorkerProcesamiento.run-71"><span class="linenos">71</span></a>                <span class="k">return</span>
</span><span id="WorkerProcesamiento.run-72"><a href="#WorkerProcesamiento.run-72"><span class="linenos">72</span></a>
</span><span id="WorkerProcesamiento.run-73"><a href="#WorkerProcesamiento.run-73"><span class="linenos">73</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapa_manual</span><span class="p">:</span>
</span><span id="WorkerProcesamiento.run-74"><a href="#WorkerProcesamiento.run-74"><span class="linenos">74</span></a>                <span class="n">engine</span><span class="o">.</span><span class="n">mapa_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapa_manual</span>
</span><span id="WorkerProcesamiento.run-75"><a href="#WorkerProcesamiento.run-75"><span class="linenos">75</span></a>
</span><span id="WorkerProcesamiento.run-76"><a href="#WorkerProcesamiento.run-76"><span class="linenos">76</span></a>            <span class="n">validator</span> <span class="o">=</span> <span class="n">Validator</span><span class="p">(</span>
</span><span id="WorkerProcesamiento.run-77"><a href="#WorkerProcesamiento.run-77"><span class="linenos">77</span></a>                <span class="n">engine</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">mapa_cols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curso</span><span class="p">,</span> <span class="n">dict_aliases</span><span class="p">,</span>
</span><span id="WorkerProcesamiento.run-78"><a href="#WorkerProcesamiento.run-78"><span class="linenos">78</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mapa_actividades</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">esquema_ponderacion</span>
</span><span id="WorkerProcesamiento.run-79"><a href="#WorkerProcesamiento.run-79"><span class="linenos">79</span></a>            <span class="p">)</span>
</span><span id="WorkerProcesamiento.run-80"><a href="#WorkerProcesamiento.run-80"><span class="linenos">80</span></a>            <span class="n">validos</span><span class="p">,</span> <span class="n">revision</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">procesar</span><span class="p">()</span>
</span><span id="WorkerProcesamiento.run-81"><a href="#WorkerProcesamiento.run-81"><span class="linenos">81</span></a>
</span><span id="WorkerProcesamiento.run-82"><a href="#WorkerProcesamiento.run-82"><span class="linenos">82</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">validos</span><span class="p">,</span> <span class="n">revision</span><span class="p">)</span>
</span><span id="WorkerProcesamiento.run-83"><a href="#WorkerProcesamiento.run-83"><span class="linenos">83</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorkerProcesamiento.run-84"><a href="#WorkerProcesamiento.run-84"><span class="linenos">84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error interno en Worker: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Ejecuta la lógica de carga, mapeo y validación de datos.
Emite señal 'finished' con los resultados o 'error' si falla.</p>
</div>


                            </div>
                </section>
                <section id="WorkerGuardado">
                            <input id="WorkerGuardado-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">WorkerGuardado</span><wbr>(<span class="base">PyQt6.QtCore.QObject</span>):

                <label class="view-source-button" for="WorkerGuardado-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WorkerGuardado"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WorkerGuardado-87"><a href="#WorkerGuardado-87"><span class="linenos"> 87</span></a><span class="k">class</span><span class="w"> </span><span class="nc">WorkerGuardado</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
</span><span id="WorkerGuardado-88"><a href="#WorkerGuardado-88"><span class="linenos"> 88</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="WorkerGuardado-89"><a href="#WorkerGuardado-89"><span class="linenos"> 89</span></a><span class="sd">    Hilo de trabajo dedicado exclusivamente a la persistencia de datos en la base de datos</span>
</span><span id="WorkerGuardado-90"><a href="#WorkerGuardado-90"><span class="linenos"> 90</span></a><span class="sd">    para evitar congelar la interfaz gráfica.</span>
</span><span id="WorkerGuardado-91"><a href="#WorkerGuardado-91"><span class="linenos"> 91</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="WorkerGuardado-92"><a href="#WorkerGuardado-92"><span class="linenos"> 92</span></a>    <span class="n">finished</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="n">ResultadoProceso</span><span class="p">)</span>
</span><span id="WorkerGuardado-93"><a href="#WorkerGuardado-93"><span class="linenos"> 93</span></a>    <span class="n">error</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="WorkerGuardado-94"><a href="#WorkerGuardado-94"><span class="linenos"> 94</span></a>
</span><span id="WorkerGuardado-95"><a href="#WorkerGuardado-95"><span class="linenos"> 95</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">persistence_service</span><span class="p">,</span> <span class="n">lista_datos</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RegistroImportado</span><span class="p">],</span> <span class="n">curso_id</span><span class="p">):</span>
</span><span id="WorkerGuardado-96"><a href="#WorkerGuardado-96"><span class="linenos"> 96</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="WorkerGuardado-97"><a href="#WorkerGuardado-97"><span class="linenos"> 97</span></a><span class="sd">        Inicializa el worker de guardado.</span>
</span><span id="WorkerGuardado-98"><a href="#WorkerGuardado-98"><span class="linenos"> 98</span></a>
</span><span id="WorkerGuardado-99"><a href="#WorkerGuardado-99"><span class="linenos"> 99</span></a><span class="sd">        Args:</span>
</span><span id="WorkerGuardado-100"><a href="#WorkerGuardado-100"><span class="linenos">100</span></a><span class="sd">            persistence_service (PersistenceService): Instancia del servicio de persistencia.</span>
</span><span id="WorkerGuardado-101"><a href="#WorkerGuardado-101"><span class="linenos">101</span></a><span class="sd">            lista_datos (List[RegistroImportado]): Lista de registros validados y listos para guardar.</span>
</span><span id="WorkerGuardado-102"><a href="#WorkerGuardado-102"><span class="linenos">102</span></a><span class="sd">            curso_id (str): ID del curso destino.</span>
</span><span id="WorkerGuardado-103"><a href="#WorkerGuardado-103"><span class="linenos">103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorkerGuardado-104"><a href="#WorkerGuardado-104"><span class="linenos">104</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="WorkerGuardado-105"><a href="#WorkerGuardado-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">persistence_service</span>
</span><span id="WorkerGuardado-106"><a href="#WorkerGuardado-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lista</span> <span class="o">=</span> <span class="n">lista_datos</span>
</span><span id="WorkerGuardado-107"><a href="#WorkerGuardado-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">curso_id</span> <span class="o">=</span> <span class="n">curso_id</span>
</span><span id="WorkerGuardado-108"><a href="#WorkerGuardado-108"><span class="linenos">108</span></a>
</span><span id="WorkerGuardado-109"><a href="#WorkerGuardado-109"><span class="linenos">109</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="WorkerGuardado-110"><a href="#WorkerGuardado-110"><span class="linenos">110</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="WorkerGuardado-111"><a href="#WorkerGuardado-111"><span class="linenos">111</span></a><span class="sd">        Ejecuta el guardado por lotes llamando al servicio de persistencia.</span>
</span><span id="WorkerGuardado-112"><a href="#WorkerGuardado-112"><span class="linenos">112</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorkerGuardado-113"><a href="#WorkerGuardado-113"><span class="linenos">113</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="WorkerGuardado-114"><a href="#WorkerGuardado-114"><span class="linenos">114</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">guardar_lote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lista</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curso_id</span><span class="p">)</span>
</span><span id="WorkerGuardado-115"><a href="#WorkerGuardado-115"><span class="linenos">115</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="WorkerGuardado-116"><a href="#WorkerGuardado-116"><span class="linenos">116</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorkerGuardado-117"><a href="#WorkerGuardado-117"><span class="linenos">117</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Hilo de trabajo dedicado exclusivamente a la persistencia de datos en la base de datos
para evitar congelar la interfaz gráfica.</p>
</div>


                            <div id="WorkerGuardado.__init__" class="classattr">
                                        <input id="WorkerGuardado.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">WorkerGuardado</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">persistence_service</span>,</span><span class="param">	<span class="n">lista_datos</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="../database/schemas.html#RegistroImportado">database.schemas.RegistroImportado</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">curso_id</span></span>)</span>

                <label class="view-source-button" for="WorkerGuardado.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WorkerGuardado.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WorkerGuardado.__init__-95"><a href="#WorkerGuardado.__init__-95"><span class="linenos"> 95</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">persistence_service</span><span class="p">,</span> <span class="n">lista_datos</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RegistroImportado</span><span class="p">],</span> <span class="n">curso_id</span><span class="p">):</span>
</span><span id="WorkerGuardado.__init__-96"><a href="#WorkerGuardado.__init__-96"><span class="linenos"> 96</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="WorkerGuardado.__init__-97"><a href="#WorkerGuardado.__init__-97"><span class="linenos"> 97</span></a><span class="sd">        Inicializa el worker de guardado.</span>
</span><span id="WorkerGuardado.__init__-98"><a href="#WorkerGuardado.__init__-98"><span class="linenos"> 98</span></a>
</span><span id="WorkerGuardado.__init__-99"><a href="#WorkerGuardado.__init__-99"><span class="linenos"> 99</span></a><span class="sd">        Args:</span>
</span><span id="WorkerGuardado.__init__-100"><a href="#WorkerGuardado.__init__-100"><span class="linenos">100</span></a><span class="sd">            persistence_service (PersistenceService): Instancia del servicio de persistencia.</span>
</span><span id="WorkerGuardado.__init__-101"><a href="#WorkerGuardado.__init__-101"><span class="linenos">101</span></a><span class="sd">            lista_datos (List[RegistroImportado]): Lista de registros validados y listos para guardar.</span>
</span><span id="WorkerGuardado.__init__-102"><a href="#WorkerGuardado.__init__-102"><span class="linenos">102</span></a><span class="sd">            curso_id (str): ID del curso destino.</span>
</span><span id="WorkerGuardado.__init__-103"><a href="#WorkerGuardado.__init__-103"><span class="linenos">103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorkerGuardado.__init__-104"><a href="#WorkerGuardado.__init__-104"><span class="linenos">104</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="WorkerGuardado.__init__-105"><a href="#WorkerGuardado.__init__-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">persistence_service</span>
</span><span id="WorkerGuardado.__init__-106"><a href="#WorkerGuardado.__init__-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lista</span> <span class="o">=</span> <span class="n">lista_datos</span>
</span><span id="WorkerGuardado.__init__-107"><a href="#WorkerGuardado.__init__-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">curso_id</span> <span class="o">=</span> <span class="n">curso_id</span>
</span></pre></div>


            <div class="docstring"><p>Inicializa el worker de guardado.</p>

<p>Args:
    persistence_service (PersistenceService): Instancia del servicio de persistencia.
    lista_datos (List[RegistroImportado]): Lista de registros validados y listos para guardar.
    curso_id (str): ID del curso destino.</p>
</div>


                            </div>
                            <div id="WorkerGuardado.finished" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">finished</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#WorkerGuardado.finished"></a>
    
            <div class="docstring"><p>pyqtSignal(*types, name: str = ..., revision: int = ..., arguments: Sequence = ...) -> PYQT_SIGNAL</p>

<p>types is normally a sequence of individual types.  Each type is either a
type object or a string that is the name of a C++ type.  Alternatively
each type could itself be a sequence of types each describing a different
overloaded signal.
name is the optional C++ name of the signal.  If it is not specified then
the name of the class attribute that is bound to the signal is used.
revision is the optional revision of the signal that is exported to QML.
If it is not specified then 0 is used.
arguments is the optional sequence of the names of the signal's arguments.</p>
</div>


                            </div>
                            <div id="WorkerGuardado.error" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">error</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#WorkerGuardado.error"></a>
    
            <div class="docstring"><p>pyqtSignal(*types, name: str = ..., revision: int = ..., arguments: Sequence = ...) -> PYQT_SIGNAL</p>

<p>types is normally a sequence of individual types.  Each type is either a
type object or a string that is the name of a C++ type.  Alternatively
each type could itself be a sequence of types each describing a different
overloaded signal.
name is the optional C++ name of the signal.  If it is not specified then
the name of the class attribute that is bound to the signal is used.
revision is the optional revision of the signal that is exported to QML.
If it is not specified then 0 is used.
arguments is the optional sequence of the names of the signal's arguments.</p>
</div>


                            </div>
                            <div id="WorkerGuardado.service" class="classattr">
                                <div class="attr variable">
            <span class="name">service</span>

        
    </div>
    <a class="headerlink" href="#WorkerGuardado.service"></a>
    
    

                            </div>
                            <div id="WorkerGuardado.lista" class="classattr">
                                <div class="attr variable">
            <span class="name">lista</span>

        
    </div>
    <a class="headerlink" href="#WorkerGuardado.lista"></a>
    
    

                            </div>
                            <div id="WorkerGuardado.curso_id" class="classattr">
                                <div class="attr variable">
            <span class="name">curso_id</span>

        
    </div>
    <a class="headerlink" href="#WorkerGuardado.curso_id"></a>
    
    

                            </div>
                            <div id="WorkerGuardado.run" class="classattr">
                                        <input id="WorkerGuardado.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="WorkerGuardado.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WorkerGuardado.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WorkerGuardado.run-109"><a href="#WorkerGuardado.run-109"><span class="linenos">109</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="WorkerGuardado.run-110"><a href="#WorkerGuardado.run-110"><span class="linenos">110</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="WorkerGuardado.run-111"><a href="#WorkerGuardado.run-111"><span class="linenos">111</span></a><span class="sd">        Ejecuta el guardado por lotes llamando al servicio de persistencia.</span>
</span><span id="WorkerGuardado.run-112"><a href="#WorkerGuardado.run-112"><span class="linenos">112</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorkerGuardado.run-113"><a href="#WorkerGuardado.run-113"><span class="linenos">113</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="WorkerGuardado.run-114"><a href="#WorkerGuardado.run-114"><span class="linenos">114</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">guardar_lote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lista</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curso_id</span><span class="p">)</span>
</span><span id="WorkerGuardado.run-115"><a href="#WorkerGuardado.run-115"><span class="linenos">115</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="WorkerGuardado.run-116"><a href="#WorkerGuardado.run-116"><span class="linenos">116</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorkerGuardado.run-117"><a href="#WorkerGuardado.run-117"><span class="linenos">117</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Ejecuta el guardado por lotes llamando al servicio de persistencia.</p>
</div>


                            </div>
                </section>
                <section id="GestorImportacion">
                            <input id="GestorImportacion-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">GestorImportacion</span>:

                <label class="view-source-button" for="GestorImportacion-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GestorImportacion"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GestorImportacion-120"><a href="#GestorImportacion-120"><span class="linenos">120</span></a><span class="k">class</span><span class="w"> </span><span class="nc">GestorImportacion</span><span class="p">:</span>
</span><span id="GestorImportacion-121"><a href="#GestorImportacion-121"><span class="linenos">121</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-122"><a href="#GestorImportacion-122"><span class="linenos">122</span></a><span class="sd">    Controlador principal que orquesta todo el flujo de importación de datos desde Excel.</span>
</span><span id="GestorImportacion-123"><a href="#GestorImportacion-123"><span class="linenos">123</span></a><span class="sd">    Maneja la UI de selección, mapeo de columnas, validación interactiva y guardado.</span>
</span><span id="GestorImportacion-124"><a href="#GestorImportacion-124"><span class="linenos">124</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="GestorImportacion-125"><a href="#GestorImportacion-125"><span class="linenos">125</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_widget</span><span class="p">):</span>
</span><span id="GestorImportacion-126"><a href="#GestorImportacion-126"><span class="linenos">126</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-127"><a href="#GestorImportacion-127"><span class="linenos">127</span></a><span class="sd">        Inicializa el gestor.</span>
</span><span id="GestorImportacion-128"><a href="#GestorImportacion-128"><span class="linenos">128</span></a>
</span><span id="GestorImportacion-129"><a href="#GestorImportacion-129"><span class="linenos">129</span></a><span class="sd">        Args:</span>
</span><span id="GestorImportacion-130"><a href="#GestorImportacion-130"><span class="linenos">130</span></a><span class="sd">            parent_widget (QWidget): Widget padre para mostrar diálogos modales.</span>
</span><span id="GestorImportacion-131"><a href="#GestorImportacion-131"><span class="linenos">131</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GestorImportacion-132"><a href="#GestorImportacion-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent_widget</span>
</span><span id="GestorImportacion-133"><a href="#GestorImportacion-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span> <span class="o">=</span> <span class="n">PersistenceService</span><span class="p">()</span>
</span><span id="GestorImportacion-134"><a href="#GestorImportacion-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">curso_model</span> <span class="o">=</span> <span class="n">CursoModel</span><span class="p">()</span>
</span><span id="GestorImportacion-135"><a href="#GestorImportacion-135"><span class="linenos">135</span></a>
</span><span id="GestorImportacion-136"><a href="#GestorImportacion-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GestorImportacion-137"><a href="#GestorImportacion-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GestorImportacion-138"><a href="#GestorImportacion-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GestorImportacion-139"><a href="#GestorImportacion-139"><span class="linenos">139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GestorImportacion-140"><a href="#GestorImportacion-140"><span class="linenos">140</span></a>
</span><span id="GestorImportacion-141"><a href="#GestorImportacion-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GestorImportacion-142"><a href="#GestorImportacion-142"><span class="linenos">142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reporte_errores</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GestorImportacion-143"><a href="#GestorImportacion-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lista_omitidos</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># NUEVO: Lista separada para los omitidos manualmente</span>
</span><span id="GestorImportacion-144"><a href="#GestorImportacion-144"><span class="linenos">144</span></a>
</span><span id="GestorImportacion-145"><a href="#GestorImportacion-145"><span class="linenos">145</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ejecutar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GestorImportacion-146"><a href="#GestorImportacion-146"><span class="linenos">146</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-147"><a href="#GestorImportacion-147"><span class="linenos">147</span></a><span class="sd">        Inicia el asistente de importación paso a paso.</span>
</span><span id="GestorImportacion-148"><a href="#GestorImportacion-148"><span class="linenos">148</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GestorImportacion-149"><a href="#GestorImportacion-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reporte_errores</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GestorImportacion-150"><a href="#GestorImportacion-150"><span class="linenos">150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lista_omitidos</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Reiniciar omitidos</span>
</span><span id="GestorImportacion-151"><a href="#GestorImportacion-151"><span class="linenos">151</span></a>
</span><span id="GestorImportacion-152"><a href="#GestorImportacion-152"><span class="linenos">152</span></a>        <span class="c1"># 1. Selección Archivo</span>
</span><span id="GestorImportacion-153"><a href="#GestorImportacion-153"><span class="linenos">153</span></a>        <span class="n">archivo</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Seleccionar Excel&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Excel Files (*.xlsx *.ods)&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-154"><a href="#GestorImportacion-154"><span class="linenos">154</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">archivo</span><span class="p">:</span> <span class="k">return</span>
</span><span id="GestorImportacion-155"><a href="#GestorImportacion-155"><span class="linenos">155</span></a>
</span><span id="GestorImportacion-156"><a href="#GestorImportacion-156"><span class="linenos">156</span></a>        <span class="c1"># 2. Selección Curso</span>
</span><span id="GestorImportacion-157"><a href="#GestorImportacion-157"><span class="linenos">157</span></a>        <span class="n">cursos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curso_model</span><span class="o">.</span><span class="n">cursos_activos</span><span class="p">()</span>
</span><span id="GestorImportacion-158"><a href="#GestorImportacion-158"><span class="linenos">158</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cursos</span><span class="p">:</span>
</span><span id="GestorImportacion-159"><a href="#GestorImportacion-159"><span class="linenos">159</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Atención&quot;</span><span class="p">,</span> <span class="s2">&quot;No existen cursos activos.&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-160"><a href="#GestorImportacion-160"><span class="linenos">160</span></a>            <span class="k">return</span>
</span><span id="GestorImportacion-161"><a href="#GestorImportacion-161"><span class="linenos">161</span></a>
</span><span id="GestorImportacion-162"><a href="#GestorImportacion-162"><span class="linenos">162</span></a>        <span class="n">nombres</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">nombre</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cursos</span><span class="p">]</span>
</span><span id="GestorImportacion-163"><a href="#GestorImportacion-163"><span class="linenos">163</span></a>        <span class="n">sel_dialog</span> <span class="o">=</span> <span class="n">DialogoSeleccion</span><span class="p">(</span><span class="s2">&quot;Seleccionar Curso&quot;</span><span class="p">,</span> <span class="s2">&quot;Destino:&quot;</span><span class="p">,</span> <span class="n">nombres</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="GestorImportacion-164"><a href="#GestorImportacion-164"><span class="linenos">164</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_dialog</span><span class="o">.</span><span class="n">exec</span><span class="p">():</span> <span class="k">return</span>
</span><span id="GestorImportacion-165"><a href="#GestorImportacion-165"><span class="linenos">165</span></a>
</span><span id="GestorImportacion-166"><a href="#GestorImportacion-166"><span class="linenos">166</span></a>        <span class="n">nombre_curso</span> <span class="o">=</span> <span class="n">sel_dialog</span><span class="o">.</span><span class="n">obtener_seleccion</span><span class="p">()</span>
</span><span id="GestorImportacion-167"><a href="#GestorImportacion-167"><span class="linenos">167</span></a>        <span class="n">curso_seleccionado</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cursos</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="n">nombre_curso</span><span class="p">)</span>
</span><span id="GestorImportacion-168"><a href="#GestorImportacion-168"><span class="linenos">168</span></a>
</span><span id="GestorImportacion-169"><a href="#GestorImportacion-169"><span class="linenos">169</span></a>        <span class="c1"># 3. Pre-validación Columnas</span>
</span><span id="GestorImportacion-170"><a href="#GestorImportacion-170"><span class="linenos">170</span></a>        <span class="n">engine_pre</span> <span class="o">=</span> <span class="n">ExcelEngine</span><span class="p">(</span><span class="n">archivo</span><span class="p">)</span>
</span><span id="GestorImportacion-171"><a href="#GestorImportacion-171"><span class="linenos">171</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">engine_pre</span><span class="o">.</span><span class="n">cargar</span><span class="p">():</span>
</span><span id="GestorImportacion-172"><a href="#GestorImportacion-172"><span class="linenos">172</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;Archivo corrupto.&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-173"><a href="#GestorImportacion-173"><span class="linenos">173</span></a>            <span class="k">return</span>
</span><span id="GestorImportacion-174"><a href="#GestorImportacion-174"><span class="linenos">174</span></a>
</span><span id="GestorImportacion-175"><a href="#GestorImportacion-175"><span class="linenos">175</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">resolver_ui</span><span class="p">(</span><span class="n">nombre</span><span class="p">,</span> <span class="n">opciones</span><span class="p">):</span>
</span><span id="GestorImportacion-176"><a href="#GestorImportacion-176"><span class="linenos">176</span></a>            <span class="n">item</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Asignación Manual&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Falta &#39;</span><span class="si">{</span><span class="n">nombre</span><span class="si">}</span><span class="s2">&#39;:&quot;</span><span class="p">,</span> <span class="n">opciones</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="GestorImportacion-177"><a href="#GestorImportacion-177"><span class="linenos">177</span></a>            <span class="k">return</span> <span class="n">item</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="GestorImportacion-178"><a href="#GestorImportacion-178"><span class="linenos">178</span></a>
</span><span id="GestorImportacion-179"><a href="#GestorImportacion-179"><span class="linenos">179</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">engine_pre</span><span class="o">.</span><span class="n">mapear_columnas</span><span class="p">(</span><span class="n">manual_resolver_callback</span><span class="o">=</span><span class="n">resolver_ui</span><span class="p">):</span>
</span><span id="GestorImportacion-180"><a href="#GestorImportacion-180"><span class="linenos">180</span></a>            <span class="k">return</span>
</span><span id="GestorImportacion-181"><a href="#GestorImportacion-181"><span class="linenos">181</span></a>
</span><span id="GestorImportacion-182"><a href="#GestorImportacion-182"><span class="linenos">182</span></a>        <span class="c1"># --- VERIFICACIÓN Y GESTIÓN DE ESQUEMA ---</span>
</span><span id="GestorImportacion-183"><a href="#GestorImportacion-183"><span class="linenos">183</span></a>        <span class="n">esquema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span><span class="o">.</span><span class="n">obtener_esquema_curso</span><span class="p">(</span><span class="n">curso_seleccionado</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="GestorImportacion-184"><a href="#GestorImportacion-184"><span class="linenos">184</span></a>
</span><span id="GestorImportacion-185"><a href="#GestorImportacion-185"><span class="linenos">185</span></a>        <span class="c1"># Si NO hay esquema, ofrecemos crearlo</span>
</span><span id="GestorImportacion-186"><a href="#GestorImportacion-186"><span class="linenos">186</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">esquema</span><span class="p">:</span>
</span><span id="GestorImportacion-187"><a href="#GestorImportacion-187"><span class="linenos">187</span></a>            <span class="n">resp_crear</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span>
</span><span id="GestorImportacion-188"><a href="#GestorImportacion-188"><span class="linenos">188</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Sistema de Evaluación Faltante&quot;</span><span class="p">,</span>
</span><span id="GestorImportacion-189"><a href="#GestorImportacion-189"><span class="linenos">189</span></a>                <span class="sa">f</span><span class="s2">&quot;El curso &#39;</span><span class="si">{</span><span class="n">curso_seleccionado</span><span class="o">.</span><span class="n">nombre</span><span class="si">}</span><span class="s2">&#39; no tiene configurado un sistema de evaluación.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion-190"><a href="#GestorImportacion-190"><span class="linenos">190</span></a>                <span class="s2">&quot;¿Desea configurarlo AHORA para poder importar las notas del Excel?&quot;</span><span class="p">,</span>
</span><span id="GestorImportacion-191"><a href="#GestorImportacion-191"><span class="linenos">191</span></a>                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span>
</span><span id="GestorImportacion-192"><a href="#GestorImportacion-192"><span class="linenos">192</span></a>            <span class="p">)</span>
</span><span id="GestorImportacion-193"><a href="#GestorImportacion-193"><span class="linenos">193</span></a>
</span><span id="GestorImportacion-194"><a href="#GestorImportacion-194"><span class="linenos">194</span></a>            <span class="k">if</span> <span class="n">resp_crear</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
</span><span id="GestorImportacion-195"><a href="#GestorImportacion-195"><span class="linenos">195</span></a>                <span class="n">dlg_esquema</span> <span class="o">=</span> <span class="n">DialogoEsquemaEvaluacion</span><span class="p">(</span><span class="n">curso_seleccionado</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="GestorImportacion-196"><a href="#GestorImportacion-196"><span class="linenos">196</span></a>                <span class="n">dlg_esquema</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
</span><span id="GestorImportacion-197"><a href="#GestorImportacion-197"><span class="linenos">197</span></a>                <span class="n">esquema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span><span class="o">.</span><span class="n">obtener_esquema_curso</span><span class="p">(</span><span class="n">curso_seleccionado</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="GestorImportacion-198"><a href="#GestorImportacion-198"><span class="linenos">198</span></a>
</span><span id="GestorImportacion-199"><a href="#GestorImportacion-199"><span class="linenos">199</span></a>        <span class="c1"># Preparamos variables</span>
</span><span id="GestorImportacion-200"><a href="#GestorImportacion-200"><span class="linenos">200</span></a>        <span class="n">mapa_actividades</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GestorImportacion-201"><a href="#GestorImportacion-201"><span class="linenos">201</span></a>        <span class="n">esquema_ponderacion</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GestorImportacion-202"><a href="#GestorImportacion-202"><span class="linenos">202</span></a>
</span><span id="GestorImportacion-203"><a href="#GestorImportacion-203"><span class="linenos">203</span></a>        <span class="k">if</span> <span class="n">esquema</span><span class="p">:</span>
</span><span id="GestorImportacion-204"><a href="#GestorImportacion-204"><span class="linenos">204</span></a>            <span class="n">esquema_ponderacion</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;porcentaje&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">esquema</span><span class="p">}</span>
</span><span id="GestorImportacion-205"><a href="#GestorImportacion-205"><span class="linenos">205</span></a>            <span class="n">columnas_disponibles</span> <span class="o">=</span> <span class="n">engine_pre</span><span class="o">.</span><span class="n">obtener_columnas_restantes</span><span class="p">()</span>
</span><span id="GestorImportacion-206"><a href="#GestorImportacion-206"><span class="linenos">206</span></a>
</span><span id="GestorImportacion-207"><a href="#GestorImportacion-207"><span class="linenos">207</span></a>            <span class="n">dialogo_mapeo</span> <span class="o">=</span> <span class="n">DialogoMapeoNotas</span><span class="p">(</span><span class="n">columnas_disponibles</span><span class="p">,</span> <span class="n">esquema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="GestorImportacion-208"><a href="#GestorImportacion-208"><span class="linenos">208</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dialogo_mapeo</span><span class="o">.</span><span class="n">exec</span><span class="p">():</span>
</span><span id="GestorImportacion-209"><a href="#GestorImportacion-209"><span class="linenos">209</span></a>                <span class="k">return</span>  <span class="c1"># Cancelado en mapeo</span>
</span><span id="GestorImportacion-210"><a href="#GestorImportacion-210"><span class="linenos">210</span></a>
</span><span id="GestorImportacion-211"><a href="#GestorImportacion-211"><span class="linenos">211</span></a>            <span class="n">mapa_actividades</span> <span class="o">=</span> <span class="n">dialogo_mapeo</span><span class="o">.</span><span class="n">obtener_mapeo</span><span class="p">()</span>
</span><span id="GestorImportacion-212"><a href="#GestorImportacion-212"><span class="linenos">212</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">mapa_actividades</span><span class="p">:</span>
</span><span id="GestorImportacion-213"><a href="#GestorImportacion-213"><span class="linenos">213</span></a>                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Info&quot;</span><span class="p">,</span> <span class="s2">&quot;No vinculó columnas. Se importarán solo datos personales.&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-214"><a href="#GestorImportacion-214"><span class="linenos">214</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GestorImportacion-215"><a href="#GestorImportacion-215"><span class="linenos">215</span></a>            <span class="n">resp_final</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="GestorImportacion-216"><a href="#GestorImportacion-216"><span class="linenos">216</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Importación Parcial&quot;</span><span class="p">,</span>
</span><span id="GestorImportacion-217"><a href="#GestorImportacion-217"><span class="linenos">217</span></a>                <span class="s2">&quot;⚠️ No hay esquema de evaluación.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion-218"><a href="#GestorImportacion-218"><span class="linenos">218</span></a>                <span class="s2">&quot;Se importarán SOLO los estudiantes y matrículas (Sin Calificaciones).</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion-219"><a href="#GestorImportacion-219"><span class="linenos">219</span></a>                <span class="s2">&quot;¿Desea continuar?&quot;</span><span class="p">,</span>
</span><span id="GestorImportacion-220"><a href="#GestorImportacion-220"><span class="linenos">220</span></a>                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span>
</span><span id="GestorImportacion-221"><a href="#GestorImportacion-221"><span class="linenos">221</span></a>            <span class="p">)</span>
</span><span id="GestorImportacion-222"><a href="#GestorImportacion-222"><span class="linenos">222</span></a>            <span class="k">if</span> <span class="n">resp_final</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span><span class="p">:</span>
</span><span id="GestorImportacion-223"><a href="#GestorImportacion-223"><span class="linenos">223</span></a>                <span class="k">return</span>
</span><span id="GestorImportacion-224"><a href="#GestorImportacion-224"><span class="linenos">224</span></a>
</span><span id="GestorImportacion-225"><a href="#GestorImportacion-225"><span class="linenos">225</span></a>        <span class="c1"># 4. Iniciar Worker</span>
</span><span id="GestorImportacion-226"><a href="#GestorImportacion-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>
</span><span id="GestorImportacion-227"><a href="#GestorImportacion-227"><span class="linenos">227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span> <span class="o">=</span> <span class="n">WorkerProcesamiento</span><span class="p">(</span>
</span><span id="GestorImportacion-228"><a href="#GestorImportacion-228"><span class="linenos">228</span></a>            <span class="n">archivo</span><span class="p">,</span> <span class="n">curso_seleccionado</span><span class="p">,</span> <span class="n">engine_pre</span><span class="o">.</span><span class="n">mapa_cols</span><span class="p">,</span>
</span><span id="GestorImportacion-229"><a href="#GestorImportacion-229"><span class="linenos">229</span></a>            <span class="n">mapa_actividades</span><span class="p">,</span> <span class="n">esquema_ponderacion</span>
</span><span id="GestorImportacion-230"><a href="#GestorImportacion-230"><span class="linenos">230</span></a>        <span class="p">)</span>
</span><span id="GestorImportacion-231"><a href="#GestorImportacion-231"><span class="linenos">231</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="p">)</span>
</span><span id="GestorImportacion-232"><a href="#GestorImportacion-232"><span class="linenos">232</span></a>
</span><span id="GestorImportacion-233"><a href="#GestorImportacion-233"><span class="linenos">233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
</span><span id="GestorImportacion-234"><a href="#GestorImportacion-234"><span class="linenos">234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_al_terminar_analisis</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">curso_seleccionado</span><span class="p">))</span>
</span><span id="GestorImportacion-235"><a href="#GestorImportacion-235"><span class="linenos">235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</span><span id="GestorImportacion-236"><a href="#GestorImportacion-236"><span class="linenos">236</span></a>
</span><span id="GestorImportacion-237"><a href="#GestorImportacion-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">quit</span><span class="p">)</span>
</span><span id="GestorImportacion-238"><a href="#GestorImportacion-238"><span class="linenos">238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>
</span><span id="GestorImportacion-239"><a href="#GestorImportacion-239"><span class="linenos">239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>
</span><span id="GestorImportacion-240"><a href="#GestorImportacion-240"><span class="linenos">240</span></a>
</span><span id="GestorImportacion-241"><a href="#GestorImportacion-241"><span class="linenos">241</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="GestorImportacion-242"><a href="#GestorImportacion-242"><span class="linenos">242</span></a>
</span><span id="GestorImportacion-243"><a href="#GestorImportacion-243"><span class="linenos">243</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_al_terminar_analisis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validos</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RegistroImportado</span><span class="p">],</span> <span class="n">revision</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RegistroImportado</span><span class="p">],</span> <span class="n">curso</span><span class="p">):</span>
</span><span id="GestorImportacion-244"><a href="#GestorImportacion-244"><span class="linenos">244</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-245"><a href="#GestorImportacion-245"><span class="linenos">245</span></a><span class="sd">        Callback ejecutado cuando termina el análisis del Excel.</span>
</span><span id="GestorImportacion-246"><a href="#GestorImportacion-246"><span class="linenos">246</span></a><span class="sd">        Maneja la deduplicación, revisión interactiva y lanza el proceso de guardado.</span>
</span><span id="GestorImportacion-247"><a href="#GestorImportacion-247"><span class="linenos">247</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GestorImportacion-248"><a href="#GestorImportacion-248"><span class="linenos">248</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">validos</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">revision</span><span class="p">:</span>
</span><span id="GestorImportacion-249"><a href="#GestorImportacion-249"><span class="linenos">249</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Finalizado&quot;</span><span class="p">,</span> <span class="s2">&quot;No se encontraron registros válidos.&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-250"><a href="#GestorImportacion-250"><span class="linenos">250</span></a>            <span class="k">return</span>
</span><span id="GestorImportacion-251"><a href="#GestorImportacion-251"><span class="linenos">251</span></a>
</span><span id="GestorImportacion-252"><a href="#GestorImportacion-252"><span class="linenos">252</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span><span class="o">.</span><span class="n">cargar_caches</span><span class="p">(</span><span class="n">curso</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="GestorImportacion-253"><a href="#GestorImportacion-253"><span class="linenos">253</span></a>
</span><span id="GestorImportacion-254"><a href="#GestorImportacion-254"><span class="linenos">254</span></a>        <span class="c1"># --- FASE 1: DEDUPLICACIÓN ---</span>
</span><span id="GestorImportacion-255"><a href="#GestorImportacion-255"><span class="linenos">255</span></a>        <span class="n">mapa_maestro</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RegistroImportado</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GestorImportacion-256"><a href="#GestorImportacion-256"><span class="linenos">256</span></a>        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">validos</span><span class="p">:</span>
</span><span id="GestorImportacion-257"><a href="#GestorImportacion-257"><span class="linenos">257</span></a>            <span class="k">if</span> <span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span> <span class="ow">in</span> <span class="n">mapa_maestro</span><span class="p">:</span>
</span><span id="GestorImportacion-258"><a href="#GestorImportacion-258"><span class="linenos">258</span></a>                <span class="n">anterior</span> <span class="o">=</span> <span class="n">mapa_maestro</span><span class="p">[</span><span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span><span class="p">]</span>
</span><span id="GestorImportacion-259"><a href="#GestorImportacion-259"><span class="linenos">259</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reporte_errores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duplicado interno: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span><span class="si">}</span><span class="s2"> (Se usa fila </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">fila_excel</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-260"><a href="#GestorImportacion-260"><span class="linenos">260</span></a>            <span class="n">mapa_maestro</span><span class="p">[</span><span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span>
</span><span id="GestorImportacion-261"><a href="#GestorImportacion-261"><span class="linenos">261</span></a>
</span><span id="GestorImportacion-262"><a href="#GestorImportacion-262"><span class="linenos">262</span></a>        <span class="c1"># --- FASE 2: RESOLUCIÓN ---</span>
</span><span id="GestorImportacion-263"><a href="#GestorImportacion-263"><span class="linenos">263</span></a>        <span class="n">corregidos</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GestorImportacion-264"><a href="#GestorImportacion-264"><span class="linenos">264</span></a>        <span class="k">if</span> <span class="n">revision</span><span class="p">:</span>
</span><span id="GestorImportacion-265"><a href="#GestorImportacion-265"><span class="linenos">265</span></a>            <span class="n">corregidos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolver_revisiones_interactivas</span><span class="p">(</span><span class="n">revision</span><span class="p">,</span> <span class="n">mapa_maestro</span><span class="p">)</span>
</span><span id="GestorImportacion-266"><a href="#GestorImportacion-266"><span class="linenos">266</span></a>
</span><span id="GestorImportacion-267"><a href="#GestorImportacion-267"><span class="linenos">267</span></a>        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">corregidos</span><span class="p">:</span>
</span><span id="GestorImportacion-268"><a href="#GestorImportacion-268"><span class="linenos">268</span></a>            <span class="n">mapa_maestro</span><span class="p">[</span><span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span>
</span><span id="GestorImportacion-269"><a href="#GestorImportacion-269"><span class="linenos">269</span></a>
</span><span id="GestorImportacion-270"><a href="#GestorImportacion-270"><span class="linenos">270</span></a>        <span class="n">lista_final_unica</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapa_maestro</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="GestorImportacion-271"><a href="#GestorImportacion-271"><span class="linenos">271</span></a>
</span><span id="GestorImportacion-272"><a href="#GestorImportacion-272"><span class="linenos">272</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">lista_final_unica</span><span class="p">:</span>
</span><span id="GestorImportacion-273"><a href="#GestorImportacion-273"><span class="linenos">273</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Cancelado&quot;</span><span class="p">,</span> <span class="s2">&quot;No hay registros para guardar.&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-274"><a href="#GestorImportacion-274"><span class="linenos">274</span></a>            <span class="k">return</span>
</span><span id="GestorImportacion-275"><a href="#GestorImportacion-275"><span class="linenos">275</span></a>
</span><span id="GestorImportacion-276"><a href="#GestorImportacion-276"><span class="linenos">276</span></a>        <span class="c1"># Guardado</span>
</span><span id="GestorImportacion-277"><a href="#GestorImportacion-277"><span class="linenos">277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span> <span class="o">=</span> <span class="n">QProgressDialog</span><span class="p">(</span><span class="s2">&quot;Guardando en Base de Datos...&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="GestorImportacion-278"><a href="#GestorImportacion-278"><span class="linenos">278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Finalizando&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-279"><a href="#GestorImportacion-279"><span class="linenos">279</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="o">.</span><span class="n">setWindowModality</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowModality</span><span class="o">.</span><span class="n">WindowModal</span><span class="p">)</span>
</span><span id="GestorImportacion-280"><a href="#GestorImportacion-280"><span class="linenos">280</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="o">.</span><span class="n">setCancelButton</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="GestorImportacion-281"><a href="#GestorImportacion-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="GestorImportacion-282"><a href="#GestorImportacion-282"><span class="linenos">282</span></a>
</span><span id="GestorImportacion-283"><a href="#GestorImportacion-283"><span class="linenos">283</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>
</span><span id="GestorImportacion-284"><a href="#GestorImportacion-284"><span class="linenos">284</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span> <span class="o">=</span> <span class="n">WorkerGuardado</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span><span class="p">,</span> <span class="n">lista_final_unica</span><span class="p">,</span> <span class="n">curso</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="GestorImportacion-285"><a href="#GestorImportacion-285"><span class="linenos">285</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span><span class="p">)</span>
</span><span id="GestorImportacion-286"><a href="#GestorImportacion-286"><span class="linenos">286</span></a>
</span><span id="GestorImportacion-287"><a href="#GestorImportacion-287"><span class="linenos">287</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
</span><span id="GestorImportacion-288"><a href="#GestorImportacion-288"><span class="linenos">288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_guardado_finished</span><span class="p">)</span>
</span><span id="GestorImportacion-289"><a href="#GestorImportacion-289"><span class="linenos">289</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_guardado_error</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="GestorImportacion-290"><a href="#GestorImportacion-290"><span class="linenos">290</span></a>
</span><span id="GestorImportacion-291"><a href="#GestorImportacion-291"><span class="linenos">291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span><span class="o">.</span><span class="n">quit</span><span class="p">)</span>
</span><span id="GestorImportacion-292"><a href="#GestorImportacion-292"><span class="linenos">292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>
</span><span id="GestorImportacion-293"><a href="#GestorImportacion-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>
</span><span id="GestorImportacion-294"><a href="#GestorImportacion-294"><span class="linenos">294</span></a>
</span><span id="GestorImportacion-295"><a href="#GestorImportacion-295"><span class="linenos">295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="GestorImportacion-296"><a href="#GestorImportacion-296"><span class="linenos">296</span></a>
</span><span id="GestorImportacion-297"><a href="#GestorImportacion-297"><span class="linenos">297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_guardado_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultado</span><span class="p">:</span> <span class="n">ResultadoProceso</span><span class="p">):</span>
</span><span id="GestorImportacion-298"><a href="#GestorImportacion-298"><span class="linenos">298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback al finalizar el guardado en BD.&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-299"><a href="#GestorImportacion-299"><span class="linenos">299</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="GestorImportacion-300"><a href="#GestorImportacion-300"><span class="linenos">300</span></a>
</span><span id="GestorImportacion-301"><a href="#GestorImportacion-301"><span class="linenos">301</span></a>        <span class="c1"># Le sumamos los omitidos manualmente durante la fase de revisión</span>
</span><span id="GestorImportacion-302"><a href="#GestorImportacion-302"><span class="linenos">302</span></a>        <span class="n">resultado</span><span class="o">.</span><span class="n">registros_omitidos</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lista_omitidos</span><span class="p">)</span>
</span><span id="GestorImportacion-303"><a href="#GestorImportacion-303"><span class="linenos">303</span></a>
</span><span id="GestorImportacion-304"><a href="#GestorImportacion-304"><span class="linenos">304</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mostrar_resumen</span><span class="p">(</span><span class="n">resultado</span><span class="p">)</span>
</span><span id="GestorImportacion-305"><a href="#GestorImportacion-305"><span class="linenos">305</span></a>
</span><span id="GestorImportacion-306"><a href="#GestorImportacion-306"><span class="linenos">306</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_guardado_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">):</span>
</span><span id="GestorImportacion-307"><a href="#GestorImportacion-307"><span class="linenos">307</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback si ocurre un error crítico durante el guardado.&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-308"><a href="#GestorImportacion-308"><span class="linenos">308</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="GestorImportacion-309"><a href="#GestorImportacion-309"><span class="linenos">309</span></a>        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Error de Guardado&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Ocurrió un error al guardar:</span><span class="se">\n</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-310"><a href="#GestorImportacion-310"><span class="linenos">310</span></a>
</span><span id="GestorImportacion-311"><a href="#GestorImportacion-311"><span class="linenos">311</span></a>    <span class="c1"># --- Lógica de Revisión Interactiva ---</span>
</span><span id="GestorImportacion-312"><a href="#GestorImportacion-312"><span class="linenos">312</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_resolver_revisiones_interactivas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lista_revision</span><span class="p">,</span> <span class="n">mapa_validos</span><span class="p">):</span>
</span><span id="GestorImportacion-313"><a href="#GestorImportacion-313"><span class="linenos">313</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-314"><a href="#GestorImportacion-314"><span class="linenos">314</span></a><span class="sd">        Itera sobre registros problemáticos y solicita intervención del usuario</span>
</span><span id="GestorImportacion-315"><a href="#GestorImportacion-315"><span class="linenos">315</span></a><span class="sd">        para corregir cédulas o resolver conflictos de duplicados.</span>
</span><span id="GestorImportacion-316"><a href="#GestorImportacion-316"><span class="linenos">316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GestorImportacion-317"><a href="#GestorImportacion-317"><span class="linenos">317</span></a>        <span class="n">aceptados</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GestorImportacion-318"><a href="#GestorImportacion-318"><span class="linenos">318</span></a>        <span class="n">mapa_aceptados</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GestorImportacion-319"><a href="#GestorImportacion-319"><span class="linenos">319</span></a>        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lista_revision</span><span class="p">)</span>
</span><span id="GestorImportacion-320"><a href="#GestorImportacion-320"><span class="linenos">320</span></a>
</span><span id="GestorImportacion-321"><a href="#GestorImportacion-321"><span class="linenos">321</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lista_revision</span><span class="p">):</span>
</span><span id="GestorImportacion-322"><a href="#GestorImportacion-322"><span class="linenos">322</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="GestorImportacion-323"><a href="#GestorImportacion-323"><span class="linenos">323</span></a>                <span class="n">dialog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crear_dialogo_revision</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
</span><span id="GestorImportacion-324"><a href="#GestorImportacion-324"><span class="linenos">324</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">dialog</span><span class="o">.</span><span class="n">exec</span><span class="p">():</span>
</span><span id="GestorImportacion-325"><a href="#GestorImportacion-325"><span class="linenos">325</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confirmar_omision</span><span class="p">(</span><span class="n">reg</span><span class="p">):</span>
</span><span id="GestorImportacion-326"><a href="#GestorImportacion-326"><span class="linenos">326</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_registrar_omision</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
</span><span id="GestorImportacion-327"><a href="#GestorImportacion-327"><span class="linenos">327</span></a>                        <span class="k">break</span>
</span><span id="GestorImportacion-328"><a href="#GestorImportacion-328"><span class="linenos">328</span></a>                    <span class="k">continue</span>
</span><span id="GestorImportacion-329"><a href="#GestorImportacion-329"><span class="linenos">329</span></a>
</span><span id="GestorImportacion-330"><a href="#GestorImportacion-330"><span class="linenos">330</span></a>                <span class="n">nueva_ced</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">obtener_dato</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="GestorImportacion-331"><a href="#GestorImportacion-331"><span class="linenos">331</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">Sanitizer</span><span class="o">.</span><span class="n">validar_cedula_ecuador</span><span class="p">(</span><span class="n">nueva_ced</span><span class="p">):</span>
</span><span id="GestorImportacion-332"><a href="#GestorImportacion-332"><span class="linenos">332</span></a>                    <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;Cédula inválida.&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-333"><a href="#GestorImportacion-333"><span class="linenos">333</span></a>                    <span class="k">continue</span>
</span><span id="GestorImportacion-334"><a href="#GestorImportacion-334"><span class="linenos">334</span></a>
</span><span id="GestorImportacion-335"><a href="#GestorImportacion-335"><span class="linenos">335</span></a>                <span class="k">if</span> <span class="n">nueva_ced</span> <span class="ow">in</span> <span class="n">mapa_aceptados</span><span class="p">:</span>
</span><span id="GestorImportacion-336"><a href="#GestorImportacion-336"><span class="linenos">336</span></a>                    <span class="n">dup</span> <span class="o">=</span> <span class="n">mapa_aceptados</span><span class="p">[</span><span class="n">nueva_ced</span><span class="p">]</span>
</span><span id="GestorImportacion-337"><a href="#GestorImportacion-337"><span class="linenos">337</span></a>                    <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Duplicado&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Ya asignada a </span><span class="si">{</span><span class="n">dup</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-338"><a href="#GestorImportacion-338"><span class="linenos">338</span></a>                    <span class="k">continue</span>
</span><span id="GestorImportacion-339"><a href="#GestorImportacion-339"><span class="linenos">339</span></a>
</span><span id="GestorImportacion-340"><a href="#GestorImportacion-340"><span class="linenos">340</span></a>                <span class="k">if</span> <span class="n">nueva_ced</span> <span class="ow">in</span> <span class="n">mapa_validos</span><span class="p">:</span>
</span><span id="GestorImportacion-341"><a href="#GestorImportacion-341"><span class="linenos">341</span></a>                    <span class="n">dup</span> <span class="o">=</span> <span class="n">mapa_validos</span><span class="p">[</span><span class="n">nueva_ced</span><span class="p">]</span>
</span><span id="GestorImportacion-342"><a href="#GestorImportacion-342"><span class="linenos">342</span></a>                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CONFLICTO INTERNO: La cédula </span><span class="si">{</span><span class="n">nueva_ced</span><span class="si">}</span><span class="s2"> ya existe en el archivo.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion-343"><a href="#GestorImportacion-343"><span class="linenos">343</span></a>                           <span class="sa">f</span><span class="s2">&quot;🟦 REGISTRO EXISTENTE (Fila </span><span class="si">{</span><span class="n">dup</span><span class="o">.</span><span class="n">fila_excel</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion-344"><a href="#GestorImportacion-344"><span class="linenos">344</span></a>                           <span class="sa">f</span><span class="s2">&quot;   Nombre: </span><span class="si">{</span><span class="n">dup</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion-345"><a href="#GestorImportacion-345"><span class="linenos">345</span></a>                           <span class="sa">f</span><span class="s2">&quot;   Nota Final: </span><span class="si">{</span><span class="n">dup</span><span class="o">.</span><span class="n">nota_final</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">dup</span><span class="o">.</span><span class="n">estado_sugerido</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion-346"><a href="#GestorImportacion-346"><span class="linenos">346</span></a>                           <span class="sa">f</span><span class="s2">&quot;🟧 REGISTRO ACTUAL (Manual):</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion-347"><a href="#GestorImportacion-347"><span class="linenos">347</span></a>                           <span class="sa">f</span><span class="s2">&quot;   Nombre: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion-348"><a href="#GestorImportacion-348"><span class="linenos">348</span></a>                           <span class="sa">f</span><span class="s2">&quot;   Nota Final: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nota_final</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">estado_sugerido</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion-349"><a href="#GestorImportacion-349"><span class="linenos">349</span></a>                           <span class="sa">f</span><span class="s2">&quot;¿Qué registro desea conservar?&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-350"><a href="#GestorImportacion-350"><span class="linenos">350</span></a>
</span><span id="GestorImportacion-351"><a href="#GestorImportacion-351"><span class="linenos">351</span></a>                    <span class="n">box</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="GestorImportacion-352"><a href="#GestorImportacion-352"><span class="linenos">352</span></a>                    <span class="n">box</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Conflicto de Datos&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-353"><a href="#GestorImportacion-353"><span class="linenos">353</span></a>                    <span class="n">box</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="GestorImportacion-354"><a href="#GestorImportacion-354"><span class="linenos">354</span></a>                    <span class="n">box</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="s2">&quot;Mantener Existente&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">ButtonRole</span><span class="o">.</span><span class="n">ActionRole</span><span class="p">)</span>
</span><span id="GestorImportacion-355"><a href="#GestorImportacion-355"><span class="linenos">355</span></a>                    <span class="n">btn_act</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="s2">&quot;Sobrescribir con Actual&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">ButtonRole</span><span class="o">.</span><span class="n">ActionRole</span><span class="p">)</span>
</span><span id="GestorImportacion-356"><a href="#GestorImportacion-356"><span class="linenos">356</span></a>                    <span class="n">box</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="s2">&quot;Cancelar&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">ButtonRole</span><span class="o">.</span><span class="n">RejectRole</span><span class="p">)</span>
</span><span id="GestorImportacion-357"><a href="#GestorImportacion-357"><span class="linenos">357</span></a>
</span><span id="GestorImportacion-358"><a href="#GestorImportacion-358"><span class="linenos">358</span></a>                    <span class="n">box</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
</span><span id="GestorImportacion-359"><a href="#GestorImportacion-359"><span class="linenos">359</span></a>                    <span class="n">clicked</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">clickedButton</span><span class="p">()</span>
</span><span id="GestorImportacion-360"><a href="#GestorImportacion-360"><span class="linenos">360</span></a>
</span><span id="GestorImportacion-361"><a href="#GestorImportacion-361"><span class="linenos">361</span></a>                    <span class="k">if</span> <span class="n">clicked</span> <span class="o">==</span> <span class="n">btn_act</span><span class="p">:</span>
</span><span id="GestorImportacion-362"><a href="#GestorImportacion-362"><span class="linenos">362</span></a>                        <span class="k">pass</span>
</span><span id="GestorImportacion-363"><a href="#GestorImportacion-363"><span class="linenos">363</span></a>                    <span class="k">elif</span> <span class="n">clicked</span> <span class="o">==</span> <span class="n">box</span><span class="o">.</span><span class="n">buttons</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="GestorImportacion-364"><a href="#GestorImportacion-364"><span class="linenos">364</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">reporte_errores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GestorImportacion-365"><a href="#GestorImportacion-365"><span class="linenos">365</span></a>                            <span class="sa">f</span><span class="s2">&quot;Fusión: Se descartó </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="s2"> en favor de existente </span><span class="si">{</span><span class="n">dup</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-366"><a href="#GestorImportacion-366"><span class="linenos">366</span></a>                        <span class="c1"># Esto podría contarse como omisión técnica o fusión</span>
</span><span id="GestorImportacion-367"><a href="#GestorImportacion-367"><span class="linenos">367</span></a>                        <span class="k">break</span>
</span><span id="GestorImportacion-368"><a href="#GestorImportacion-368"><span class="linenos">368</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GestorImportacion-369"><a href="#GestorImportacion-369"><span class="linenos">369</span></a>                        <span class="k">continue</span>
</span><span id="GestorImportacion-370"><a href="#GestorImportacion-370"><span class="linenos">370</span></a>
</span><span id="GestorImportacion-371"><a href="#GestorImportacion-371"><span class="linenos">371</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validar_existencia_bd</span><span class="p">(</span><span class="n">nueva_ced</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>
</span><span id="GestorImportacion-372"><a href="#GestorImportacion-372"><span class="linenos">372</span></a>                    <span class="k">continue</span>
</span><span id="GestorImportacion-373"><a href="#GestorImportacion-373"><span class="linenos">373</span></a>
</span><span id="GestorImportacion-374"><a href="#GestorImportacion-374"><span class="linenos">374</span></a>                <span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span> <span class="o">=</span> <span class="n">nueva_ced</span>
</span><span id="GestorImportacion-375"><a href="#GestorImportacion-375"><span class="linenos">375</span></a>                <span class="n">aceptados</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
</span><span id="GestorImportacion-376"><a href="#GestorImportacion-376"><span class="linenos">376</span></a>                <span class="n">mapa_aceptados</span><span class="p">[</span><span class="n">nueva_ced</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span>
</span><span id="GestorImportacion-377"><a href="#GestorImportacion-377"><span class="linenos">377</span></a>                <span class="k">break</span>
</span><span id="GestorImportacion-378"><a href="#GestorImportacion-378"><span class="linenos">378</span></a>        <span class="k">return</span> <span class="n">aceptados</span>
</span><span id="GestorImportacion-379"><a href="#GestorImportacion-379"><span class="linenos">379</span></a>
</span><span id="GestorImportacion-380"><a href="#GestorImportacion-380"><span class="linenos">380</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_crear_dialogo_revision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
</span><span id="GestorImportacion-381"><a href="#GestorImportacion-381"><span class="linenos">381</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Crea y configura el diálogo de corrección de cédula.&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-382"><a href="#GestorImportacion-382"><span class="linenos">382</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estudiante: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="se">\n</span><span class="s2">Centro: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">centro_nombre</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion-383"><a href="#GestorImportacion-383"><span class="linenos">383</span></a>               <span class="sa">f</span><span class="s2">&quot;Problema: Cédula &#39;</span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">cedula_original</span><span class="si">}</span><span class="s2">&#39; inválida.</span><span class="se">\n</span><span class="s2">Ingrese la correcta:&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-384"><a href="#GestorImportacion-384"><span class="linenos">384</span></a>        <span class="n">val</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">cedula_limpia</span> <span class="ow">or</span> <span class="n">reg</span><span class="o">.</span><span class="n">cedula_original</span>
</span><span id="GestorImportacion-385"><a href="#GestorImportacion-385"><span class="linenos">385</span></a>        <span class="k">return</span> <span class="n">DialogoEntrada</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Revisión (</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="GestorImportacion-386"><a href="#GestorImportacion-386"><span class="linenos">386</span></a>
</span><span id="GestorImportacion-387"><a href="#GestorImportacion-387"><span class="linenos">387</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_confirmar_omision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="GestorImportacion-388"><a href="#GestorImportacion-388"><span class="linenos">388</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Pregunta al usuario si desea descartar definitivamente un registro.&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-389"><a href="#GestorImportacion-389"><span class="linenos">389</span></a>        <span class="k">return</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Omitir&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;¿Omitir a </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="s2">?&quot;</span><span class="p">,</span>
</span><span id="GestorImportacion-390"><a href="#GestorImportacion-390"><span class="linenos">390</span></a>                                    <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span><span class="p">)</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span>
</span><span id="GestorImportacion-391"><a href="#GestorImportacion-391"><span class="linenos">391</span></a>
</span><span id="GestorImportacion-392"><a href="#GestorImportacion-392"><span class="linenos">392</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_registrar_omision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>
</span><span id="GestorImportacion-393"><a href="#GestorImportacion-393"><span class="linenos">393</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Registra un registro omitido en las listas de control y reportes.&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-394"><a href="#GestorImportacion-394"><span class="linenos">394</span></a>        <span class="c1"># Ahora registramos en lista específica Y en errores para el log</span>
</span><span id="GestorImportacion-395"><a href="#GestorImportacion-395"><span class="linenos">395</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lista_omitidos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
</span><span id="GestorImportacion-396"><a href="#GestorImportacion-396"><span class="linenos">396</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reporte_errores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Omitido por usuario: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="s2"> (Cédula: </span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">cedula_original</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-397"><a href="#GestorImportacion-397"><span class="linenos">397</span></a>
</span><span id="GestorImportacion-398"><a href="#GestorImportacion-398"><span class="linenos">398</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validar_existencia_bd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cedula</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>
</span><span id="GestorImportacion-399"><a href="#GestorImportacion-399"><span class="linenos">399</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-400"><a href="#GestorImportacion-400"><span class="linenos">400</span></a><span class="sd">        Verifica si la cédula ya existe en la base de datos y pregunta al usuario</span>
</span><span id="GestorImportacion-401"><a href="#GestorImportacion-401"><span class="linenos">401</span></a><span class="sd">        si desea fusionar los datos.</span>
</span><span id="GestorImportacion-402"><a href="#GestorImportacion-402"><span class="linenos">402</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GestorImportacion-403"><a href="#GestorImportacion-403"><span class="linenos">403</span></a>        <span class="n">est_bd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span><span class="o">.</span><span class="n">cache_estudiantes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cedula</span><span class="p">)</span>
</span><span id="GestorImportacion-404"><a href="#GestorImportacion-404"><span class="linenos">404</span></a>        <span class="k">if</span> <span class="n">est_bd</span><span class="p">:</span>
</span><span id="GestorImportacion-405"><a href="#GestorImportacion-405"><span class="linenos">405</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;La cédula </span><span class="si">{</span><span class="n">cedula</span><span class="si">}</span><span class="s2"> existe en BD:</span><span class="se">\n</span><span class="si">{</span><span class="n">est_bd</span><span class="o">.</span><span class="n">nombre</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion-406"><a href="#GestorImportacion-406"><span class="linenos">406</span></a>                   <span class="sa">f</span><span class="s2">&quot;¿FUSIONAR con el registro actual (</span><span class="si">{</span><span class="n">reg</span><span class="o">.</span><span class="n">nombre_limpio</span><span class="si">}</span><span class="s2">)?</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion-407"><a href="#GestorImportacion-407"><span class="linenos">407</span></a>                   <span class="sa">f</span><span class="s2">&quot;ℹ️ IMPLICACIÓN: Se asignarán la matrícula y notas de este Excel al estudiante existente (</span><span class="si">{</span><span class="n">est_bd</span><span class="o">.</span><span class="n">nombre</span><span class="si">}</span><span class="s2">), &quot;</span>
</span><span id="GestorImportacion-408"><a href="#GestorImportacion-408"><span class="linenos">408</span></a>                   <span class="sa">f</span><span class="s2">&quot;ignorando el nombre mal escrito que aparece en el archivo.&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-409"><a href="#GestorImportacion-409"><span class="linenos">409</span></a>            <span class="k">return</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Existente en BD&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
</span><span id="GestorImportacion-410"><a href="#GestorImportacion-410"><span class="linenos">410</span></a>                                        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span><span class="p">)</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span>
</span><span id="GestorImportacion-411"><a href="#GestorImportacion-411"><span class="linenos">411</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="GestorImportacion-412"><a href="#GestorImportacion-412"><span class="linenos">412</span></a>
</span><span id="GestorImportacion-413"><a href="#GestorImportacion-413"><span class="linenos">413</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_mostrar_resumen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultado</span><span class="p">):</span>
</span><span id="GestorImportacion-414"><a href="#GestorImportacion-414"><span class="linenos">414</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Muestra el diálogo final con las estadísticas del proceso.&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-415"><a href="#GestorImportacion-415"><span class="linenos">415</span></a>        <span class="c1"># Mensaje con formato detallado y viñetas</span>
</span><span id="GestorImportacion-416"><a href="#GestorImportacion-416"><span class="linenos">416</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GestorImportacion-417"><a href="#GestorImportacion-417"><span class="linenos">417</span></a>            <span class="s2">&quot;&lt;b&gt;Proceso de Importación Finalizado&lt;/b&gt;&quot;</span>
</span><span id="GestorImportacion-418"><a href="#GestorImportacion-418"><span class="linenos">418</span></a>            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;b&gt;Proceso de Importación Finalizado&lt;/b&gt;&lt;br&gt;&lt;br&gt;</span>
</span><span id="GestorImportacion-419"><a href="#GestorImportacion-419"><span class="linenos">419</span></a><span class="s2">                &lt;b&gt;Nuevos Estudiantes:&lt;/b&gt; </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">nuevos_estudiantes</span><span class="si">}</span><span class="s2">&lt;br&gt;</span>
</span><span id="GestorImportacion-420"><a href="#GestorImportacion-420"><span class="linenos">420</span></a><span class="s2">                &lt;b&gt;Matrículas Nuevas (Inscripciones):&lt;/b&gt; </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">matriculas_nuevas</span><span class="si">}</span><span class="s2">&lt;br&gt;</span>
</span><span id="GestorImportacion-421"><a href="#GestorImportacion-421"><span class="linenos">421</span></a><span class="s2">                &lt;b&gt;Matrículas Actualizadas (Notas):&lt;/b&gt; </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">matriculas_actualizadas</span><span class="si">}</span><span class="s2">&lt;br&gt;</span>
</span><span id="GestorImportacion-422"><a href="#GestorImportacion-422"><span class="linenos">422</span></a><span class="s2">                &lt;b&gt;Registros Omitidos:&lt;/b&gt; &lt;span style=&quot;color:red&quot;&gt;</span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">registros_omitidos</span><span class="si">}</span><span class="s2">&lt;/span&gt;&lt;br&gt;&lt;br&gt;</span>
</span><span id="GestorImportacion-423"><a href="#GestorImportacion-423"><span class="linenos">423</span></a><span class="s2">                &lt;i&gt;Errores técnicos: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">resultado</span><span class="o">.</span><span class="n">errores</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/i&gt;&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-424"><a href="#GestorImportacion-424"><span class="linenos">424</span></a>        <span class="p">)</span>
</span><span id="GestorImportacion-425"><a href="#GestorImportacion-425"><span class="linenos">425</span></a>
</span><span id="GestorImportacion-426"><a href="#GestorImportacion-426"><span class="linenos">426</span></a>        <span class="n">box</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="GestorImportacion-427"><a href="#GestorImportacion-427"><span class="linenos">427</span></a>        <span class="n">box</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Resumen de Importación&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-428"><a href="#GestorImportacion-428"><span class="linenos">428</span></a>        <span class="n">box</span><span class="o">.</span><span class="n">setTextFormat</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">TextFormat</span><span class="o">.</span><span class="n">RichText</span><span class="p">)</span>
</span><span id="GestorImportacion-429"><a href="#GestorImportacion-429"><span class="linenos">429</span></a>        <span class="n">box</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="GestorImportacion-430"><a href="#GestorImportacion-430"><span class="linenos">430</span></a>
</span><span id="GestorImportacion-431"><a href="#GestorImportacion-431"><span class="linenos">431</span></a>        <span class="n">btn_ok</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="s2">&quot;Aceptar&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">ButtonRole</span><span class="o">.</span><span class="n">AcceptRole</span><span class="p">)</span>
</span><span id="GestorImportacion-432"><a href="#GestorImportacion-432"><span class="linenos">432</span></a>
</span><span id="GestorImportacion-433"><a href="#GestorImportacion-433"><span class="linenos">433</span></a>        <span class="n">btn_log</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GestorImportacion-434"><a href="#GestorImportacion-434"><span class="linenos">434</span></a>        <span class="k">if</span> <span class="n">resultado</span><span class="o">.</span><span class="n">errores</span> <span class="ow">or</span> <span class="n">resultado</span><span class="o">.</span><span class="n">registros_omitidos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GestorImportacion-435"><a href="#GestorImportacion-435"><span class="linenos">435</span></a>            <span class="n">box</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;&lt;br&gt;&lt;br&gt;¿Desea guardar el log de errores/omisiones?&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-436"><a href="#GestorImportacion-436"><span class="linenos">436</span></a>            <span class="n">btn_log</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span><span class="s2">&quot;Guardar Log&quot;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">ButtonRole</span><span class="o">.</span><span class="n">ActionRole</span><span class="p">)</span>
</span><span id="GestorImportacion-437"><a href="#GestorImportacion-437"><span class="linenos">437</span></a>
</span><span id="GestorImportacion-438"><a href="#GestorImportacion-438"><span class="linenos">438</span></a>        <span class="n">box</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
</span><span id="GestorImportacion-439"><a href="#GestorImportacion-439"><span class="linenos">439</span></a>
</span><span id="GestorImportacion-440"><a href="#GestorImportacion-440"><span class="linenos">440</span></a>        <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">clickedButton</span><span class="p">()</span> <span class="o">==</span> <span class="n">btn_log</span><span class="p">:</span>
</span><span id="GestorImportacion-441"><a href="#GestorImportacion-441"><span class="linenos">441</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_guardar_log</span><span class="p">(</span><span class="n">resultado</span><span class="o">.</span><span class="n">errores</span><span class="p">)</span>
</span><span id="GestorImportacion-442"><a href="#GestorImportacion-442"><span class="linenos">442</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;actualizar_cache_global&#39;</span><span class="p">):</span>
</span><span id="GestorImportacion-443"><a href="#GestorImportacion-443"><span class="linenos">443</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">actualizar_cache_global</span><span class="p">()</span>
</span><span id="GestorImportacion-444"><a href="#GestorImportacion-444"><span class="linenos">444</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;cargar_datos_tabla&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cargar_datos_tabla</span><span class="p">()</span>
</span><span id="GestorImportacion-445"><a href="#GestorImportacion-445"><span class="linenos">445</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;cargar_datos_tabla_cursos&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cargar_datos_tabla_cursos</span><span class="p">()</span>
</span><span id="GestorImportacion-446"><a href="#GestorImportacion-446"><span class="linenos">446</span></a>
</span><span id="GestorImportacion-447"><a href="#GestorImportacion-447"><span class="linenos">447</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_guardar_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errores</span><span class="p">):</span>
</span><span id="GestorImportacion-448"><a href="#GestorImportacion-448"><span class="linenos">448</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Guarda el archivo de texto con el log de errores.&quot;&quot;&quot;</span>
</span><span id="GestorImportacion-449"><a href="#GestorImportacion-449"><span class="linenos">449</span></a>        <span class="n">ruta</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span>
</span><span id="GestorImportacion-450"><a href="#GestorImportacion-450"><span class="linenos">450</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
</span><span id="GestorImportacion-451"><a href="#GestorImportacion-451"><span class="linenos">451</span></a>            <span class="s2">&quot;Guardar Log&quot;</span><span class="p">,</span>
</span><span id="GestorImportacion-452"><a href="#GestorImportacion-452"><span class="linenos">452</span></a>            <span class="sa">f</span><span class="s2">&quot;log_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.txt&quot;</span>
</span><span id="GestorImportacion-453"><a href="#GestorImportacion-453"><span class="linenos">453</span></a>        <span class="p">)</span>
</span><span id="GestorImportacion-454"><a href="#GestorImportacion-454"><span class="linenos">454</span></a>
</span><span id="GestorImportacion-455"><a href="#GestorImportacion-455"><span class="linenos">455</span></a>        <span class="k">if</span> <span class="n">ruta</span><span class="p">:</span>
</span><span id="GestorImportacion-456"><a href="#GestorImportacion-456"><span class="linenos">456</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ruta</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="GestorImportacion-457"><a href="#GestorImportacion-457"><span class="linenos">457</span></a>                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=== LOG DE ERRORES Y OMISIONES ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion-458"><a href="#GestorImportacion-458"><span class="linenos">458</span></a>                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errores</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Controlador principal que orquesta todo el flujo de importación de datos desde Excel.
Maneja la UI de selección, mapeo de columnas, validación interactiva y guardado.</p>
</div>


                            <div id="GestorImportacion.__init__" class="classattr">
                                        <input id="GestorImportacion.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">GestorImportacion</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">parent_widget</span></span>)</span>

                <label class="view-source-button" for="GestorImportacion.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GestorImportacion.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GestorImportacion.__init__-125"><a href="#GestorImportacion.__init__-125"><span class="linenos">125</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_widget</span><span class="p">):</span>
</span><span id="GestorImportacion.__init__-126"><a href="#GestorImportacion.__init__-126"><span class="linenos">126</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GestorImportacion.__init__-127"><a href="#GestorImportacion.__init__-127"><span class="linenos">127</span></a><span class="sd">        Inicializa el gestor.</span>
</span><span id="GestorImportacion.__init__-128"><a href="#GestorImportacion.__init__-128"><span class="linenos">128</span></a>
</span><span id="GestorImportacion.__init__-129"><a href="#GestorImportacion.__init__-129"><span class="linenos">129</span></a><span class="sd">        Args:</span>
</span><span id="GestorImportacion.__init__-130"><a href="#GestorImportacion.__init__-130"><span class="linenos">130</span></a><span class="sd">            parent_widget (QWidget): Widget padre para mostrar diálogos modales.</span>
</span><span id="GestorImportacion.__init__-131"><a href="#GestorImportacion.__init__-131"><span class="linenos">131</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GestorImportacion.__init__-132"><a href="#GestorImportacion.__init__-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent_widget</span>
</span><span id="GestorImportacion.__init__-133"><a href="#GestorImportacion.__init__-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span> <span class="o">=</span> <span class="n">PersistenceService</span><span class="p">()</span>
</span><span id="GestorImportacion.__init__-134"><a href="#GestorImportacion.__init__-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">curso_model</span> <span class="o">=</span> <span class="n">CursoModel</span><span class="p">()</span>
</span><span id="GestorImportacion.__init__-135"><a href="#GestorImportacion.__init__-135"><span class="linenos">135</span></a>
</span><span id="GestorImportacion.__init__-136"><a href="#GestorImportacion.__init__-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GestorImportacion.__init__-137"><a href="#GestorImportacion.__init__-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GestorImportacion.__init__-138"><a href="#GestorImportacion.__init__-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_save</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GestorImportacion.__init__-139"><a href="#GestorImportacion.__init__-139"><span class="linenos">139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_save</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GestorImportacion.__init__-140"><a href="#GestorImportacion.__init__-140"><span class="linenos">140</span></a>
</span><span id="GestorImportacion.__init__-141"><a href="#GestorImportacion.__init__-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pd_save</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GestorImportacion.__init__-142"><a href="#GestorImportacion.__init__-142"><span class="linenos">142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reporte_errores</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GestorImportacion.__init__-143"><a href="#GestorImportacion.__init__-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lista_omitidos</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># NUEVO: Lista separada para los omitidos manualmente</span>
</span></pre></div>


            <div class="docstring"><p>Inicializa el gestor.</p>

<p>Args:
    parent_widget (QWidget): Widget padre para mostrar diálogos modales.</p>
</div>


                            </div>
                            <div id="GestorImportacion.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span>

        
    </div>
    <a class="headerlink" href="#GestorImportacion.parent"></a>
    
    

                            </div>
                            <div id="GestorImportacion.persistence_service" class="classattr">
                                <div class="attr variable">
            <span class="name">persistence_service</span>

        
    </div>
    <a class="headerlink" href="#GestorImportacion.persistence_service"></a>
    
    

                            </div>
                            <div id="GestorImportacion.curso_model" class="classattr">
                                <div class="attr variable">
            <span class="name">curso_model</span>

        
    </div>
    <a class="headerlink" href="#GestorImportacion.curso_model"></a>
    
    

                            </div>
                            <div id="GestorImportacion.thread_proc" class="classattr">
                                <div class="attr variable">
            <span class="name">thread_proc</span>

        
    </div>
    <a class="headerlink" href="#GestorImportacion.thread_proc"></a>
    
    

                            </div>
                            <div id="GestorImportacion.worker_proc" class="classattr">
                                <div class="attr variable">
            <span class="name">worker_proc</span>

        
    </div>
    <a class="headerlink" href="#GestorImportacion.worker_proc"></a>
    
    

                            </div>
                            <div id="GestorImportacion.thread_save" class="classattr">
                                <div class="attr variable">
            <span class="name">thread_save</span>

        
    </div>
    <a class="headerlink" href="#GestorImportacion.thread_save"></a>
    
    

                            </div>
                            <div id="GestorImportacion.worker_save" class="classattr">
                                <div class="attr variable">
            <span class="name">worker_save</span>

        
    </div>
    <a class="headerlink" href="#GestorImportacion.worker_save"></a>
    
    

                            </div>
                            <div id="GestorImportacion.pd_save" class="classattr">
                                <div class="attr variable">
            <span class="name">pd_save</span>

        
    </div>
    <a class="headerlink" href="#GestorImportacion.pd_save"></a>
    
    

                            </div>
                            <div id="GestorImportacion.reporte_errores" class="classattr">
                                <div class="attr variable">
            <span class="name">reporte_errores</span>

        
    </div>
    <a class="headerlink" href="#GestorImportacion.reporte_errores"></a>
    
    

                            </div>
                            <div id="GestorImportacion.lista_omitidos" class="classattr">
                                <div class="attr variable">
            <span class="name">lista_omitidos</span>

        
    </div>
    <a class="headerlink" href="#GestorImportacion.lista_omitidos"></a>
    
    

                            </div>
                            <div id="GestorImportacion.ejecutar" class="classattr">
                                        <input id="GestorImportacion.ejecutar-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ejecutar</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GestorImportacion.ejecutar-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GestorImportacion.ejecutar"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GestorImportacion.ejecutar-145"><a href="#GestorImportacion.ejecutar-145"><span class="linenos">145</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ejecutar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GestorImportacion.ejecutar-146"><a href="#GestorImportacion.ejecutar-146"><span class="linenos">146</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GestorImportacion.ejecutar-147"><a href="#GestorImportacion.ejecutar-147"><span class="linenos">147</span></a><span class="sd">        Inicia el asistente de importación paso a paso.</span>
</span><span id="GestorImportacion.ejecutar-148"><a href="#GestorImportacion.ejecutar-148"><span class="linenos">148</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GestorImportacion.ejecutar-149"><a href="#GestorImportacion.ejecutar-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reporte_errores</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GestorImportacion.ejecutar-150"><a href="#GestorImportacion.ejecutar-150"><span class="linenos">150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lista_omitidos</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Reiniciar omitidos</span>
</span><span id="GestorImportacion.ejecutar-151"><a href="#GestorImportacion.ejecutar-151"><span class="linenos">151</span></a>
</span><span id="GestorImportacion.ejecutar-152"><a href="#GestorImportacion.ejecutar-152"><span class="linenos">152</span></a>        <span class="c1"># 1. Selección Archivo</span>
</span><span id="GestorImportacion.ejecutar-153"><a href="#GestorImportacion.ejecutar-153"><span class="linenos">153</span></a>        <span class="n">archivo</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Seleccionar Excel&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Excel Files (*.xlsx *.ods)&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-154"><a href="#GestorImportacion.ejecutar-154"><span class="linenos">154</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">archivo</span><span class="p">:</span> <span class="k">return</span>
</span><span id="GestorImportacion.ejecutar-155"><a href="#GestorImportacion.ejecutar-155"><span class="linenos">155</span></a>
</span><span id="GestorImportacion.ejecutar-156"><a href="#GestorImportacion.ejecutar-156"><span class="linenos">156</span></a>        <span class="c1"># 2. Selección Curso</span>
</span><span id="GestorImportacion.ejecutar-157"><a href="#GestorImportacion.ejecutar-157"><span class="linenos">157</span></a>        <span class="n">cursos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curso_model</span><span class="o">.</span><span class="n">cursos_activos</span><span class="p">()</span>
</span><span id="GestorImportacion.ejecutar-158"><a href="#GestorImportacion.ejecutar-158"><span class="linenos">158</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cursos</span><span class="p">:</span>
</span><span id="GestorImportacion.ejecutar-159"><a href="#GestorImportacion.ejecutar-159"><span class="linenos">159</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Atención&quot;</span><span class="p">,</span> <span class="s2">&quot;No existen cursos activos.&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-160"><a href="#GestorImportacion.ejecutar-160"><span class="linenos">160</span></a>            <span class="k">return</span>
</span><span id="GestorImportacion.ejecutar-161"><a href="#GestorImportacion.ejecutar-161"><span class="linenos">161</span></a>
</span><span id="GestorImportacion.ejecutar-162"><a href="#GestorImportacion.ejecutar-162"><span class="linenos">162</span></a>        <span class="n">nombres</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">nombre</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cursos</span><span class="p">]</span>
</span><span id="GestorImportacion.ejecutar-163"><a href="#GestorImportacion.ejecutar-163"><span class="linenos">163</span></a>        <span class="n">sel_dialog</span> <span class="o">=</span> <span class="n">DialogoSeleccion</span><span class="p">(</span><span class="s2">&quot;Seleccionar Curso&quot;</span><span class="p">,</span> <span class="s2">&quot;Destino:&quot;</span><span class="p">,</span> <span class="n">nombres</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-164"><a href="#GestorImportacion.ejecutar-164"><span class="linenos">164</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_dialog</span><span class="o">.</span><span class="n">exec</span><span class="p">():</span> <span class="k">return</span>
</span><span id="GestorImportacion.ejecutar-165"><a href="#GestorImportacion.ejecutar-165"><span class="linenos">165</span></a>
</span><span id="GestorImportacion.ejecutar-166"><a href="#GestorImportacion.ejecutar-166"><span class="linenos">166</span></a>        <span class="n">nombre_curso</span> <span class="o">=</span> <span class="n">sel_dialog</span><span class="o">.</span><span class="n">obtener_seleccion</span><span class="p">()</span>
</span><span id="GestorImportacion.ejecutar-167"><a href="#GestorImportacion.ejecutar-167"><span class="linenos">167</span></a>        <span class="n">curso_seleccionado</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cursos</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="n">nombre_curso</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-168"><a href="#GestorImportacion.ejecutar-168"><span class="linenos">168</span></a>
</span><span id="GestorImportacion.ejecutar-169"><a href="#GestorImportacion.ejecutar-169"><span class="linenos">169</span></a>        <span class="c1"># 3. Pre-validación Columnas</span>
</span><span id="GestorImportacion.ejecutar-170"><a href="#GestorImportacion.ejecutar-170"><span class="linenos">170</span></a>        <span class="n">engine_pre</span> <span class="o">=</span> <span class="n">ExcelEngine</span><span class="p">(</span><span class="n">archivo</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-171"><a href="#GestorImportacion.ejecutar-171"><span class="linenos">171</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">engine_pre</span><span class="o">.</span><span class="n">cargar</span><span class="p">():</span>
</span><span id="GestorImportacion.ejecutar-172"><a href="#GestorImportacion.ejecutar-172"><span class="linenos">172</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;Archivo corrupto.&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-173"><a href="#GestorImportacion.ejecutar-173"><span class="linenos">173</span></a>            <span class="k">return</span>
</span><span id="GestorImportacion.ejecutar-174"><a href="#GestorImportacion.ejecutar-174"><span class="linenos">174</span></a>
</span><span id="GestorImportacion.ejecutar-175"><a href="#GestorImportacion.ejecutar-175"><span class="linenos">175</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">resolver_ui</span><span class="p">(</span><span class="n">nombre</span><span class="p">,</span> <span class="n">opciones</span><span class="p">):</span>
</span><span id="GestorImportacion.ejecutar-176"><a href="#GestorImportacion.ejecutar-176"><span class="linenos">176</span></a>            <span class="n">item</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Asignación Manual&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Falta &#39;</span><span class="si">{</span><span class="n">nombre</span><span class="si">}</span><span class="s2">&#39;:&quot;</span><span class="p">,</span> <span class="n">opciones</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-177"><a href="#GestorImportacion.ejecutar-177"><span class="linenos">177</span></a>            <span class="k">return</span> <span class="n">item</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="GestorImportacion.ejecutar-178"><a href="#GestorImportacion.ejecutar-178"><span class="linenos">178</span></a>
</span><span id="GestorImportacion.ejecutar-179"><a href="#GestorImportacion.ejecutar-179"><span class="linenos">179</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">engine_pre</span><span class="o">.</span><span class="n">mapear_columnas</span><span class="p">(</span><span class="n">manual_resolver_callback</span><span class="o">=</span><span class="n">resolver_ui</span><span class="p">):</span>
</span><span id="GestorImportacion.ejecutar-180"><a href="#GestorImportacion.ejecutar-180"><span class="linenos">180</span></a>            <span class="k">return</span>
</span><span id="GestorImportacion.ejecutar-181"><a href="#GestorImportacion.ejecutar-181"><span class="linenos">181</span></a>
</span><span id="GestorImportacion.ejecutar-182"><a href="#GestorImportacion.ejecutar-182"><span class="linenos">182</span></a>        <span class="c1"># --- VERIFICACIÓN Y GESTIÓN DE ESQUEMA ---</span>
</span><span id="GestorImportacion.ejecutar-183"><a href="#GestorImportacion.ejecutar-183"><span class="linenos">183</span></a>        <span class="n">esquema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span><span class="o">.</span><span class="n">obtener_esquema_curso</span><span class="p">(</span><span class="n">curso_seleccionado</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-184"><a href="#GestorImportacion.ejecutar-184"><span class="linenos">184</span></a>
</span><span id="GestorImportacion.ejecutar-185"><a href="#GestorImportacion.ejecutar-185"><span class="linenos">185</span></a>        <span class="c1"># Si NO hay esquema, ofrecemos crearlo</span>
</span><span id="GestorImportacion.ejecutar-186"><a href="#GestorImportacion.ejecutar-186"><span class="linenos">186</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">esquema</span><span class="p">:</span>
</span><span id="GestorImportacion.ejecutar-187"><a href="#GestorImportacion.ejecutar-187"><span class="linenos">187</span></a>            <span class="n">resp_crear</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span>
</span><span id="GestorImportacion.ejecutar-188"><a href="#GestorImportacion.ejecutar-188"><span class="linenos">188</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Sistema de Evaluación Faltante&quot;</span><span class="p">,</span>
</span><span id="GestorImportacion.ejecutar-189"><a href="#GestorImportacion.ejecutar-189"><span class="linenos">189</span></a>                <span class="sa">f</span><span class="s2">&quot;El curso &#39;</span><span class="si">{</span><span class="n">curso_seleccionado</span><span class="o">.</span><span class="n">nombre</span><span class="si">}</span><span class="s2">&#39; no tiene configurado un sistema de evaluación.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion.ejecutar-190"><a href="#GestorImportacion.ejecutar-190"><span class="linenos">190</span></a>                <span class="s2">&quot;¿Desea configurarlo AHORA para poder importar las notas del Excel?&quot;</span><span class="p">,</span>
</span><span id="GestorImportacion.ejecutar-191"><a href="#GestorImportacion.ejecutar-191"><span class="linenos">191</span></a>                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span>
</span><span id="GestorImportacion.ejecutar-192"><a href="#GestorImportacion.ejecutar-192"><span class="linenos">192</span></a>            <span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-193"><a href="#GestorImportacion.ejecutar-193"><span class="linenos">193</span></a>
</span><span id="GestorImportacion.ejecutar-194"><a href="#GestorImportacion.ejecutar-194"><span class="linenos">194</span></a>            <span class="k">if</span> <span class="n">resp_crear</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
</span><span id="GestorImportacion.ejecutar-195"><a href="#GestorImportacion.ejecutar-195"><span class="linenos">195</span></a>                <span class="n">dlg_esquema</span> <span class="o">=</span> <span class="n">DialogoEsquemaEvaluacion</span><span class="p">(</span><span class="n">curso_seleccionado</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-196"><a href="#GestorImportacion.ejecutar-196"><span class="linenos">196</span></a>                <span class="n">dlg_esquema</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
</span><span id="GestorImportacion.ejecutar-197"><a href="#GestorImportacion.ejecutar-197"><span class="linenos">197</span></a>                <span class="n">esquema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence_service</span><span class="o">.</span><span class="n">obtener_esquema_curso</span><span class="p">(</span><span class="n">curso_seleccionado</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-198"><a href="#GestorImportacion.ejecutar-198"><span class="linenos">198</span></a>
</span><span id="GestorImportacion.ejecutar-199"><a href="#GestorImportacion.ejecutar-199"><span class="linenos">199</span></a>        <span class="c1"># Preparamos variables</span>
</span><span id="GestorImportacion.ejecutar-200"><a href="#GestorImportacion.ejecutar-200"><span class="linenos">200</span></a>        <span class="n">mapa_actividades</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GestorImportacion.ejecutar-201"><a href="#GestorImportacion.ejecutar-201"><span class="linenos">201</span></a>        <span class="n">esquema_ponderacion</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GestorImportacion.ejecutar-202"><a href="#GestorImportacion.ejecutar-202"><span class="linenos">202</span></a>
</span><span id="GestorImportacion.ejecutar-203"><a href="#GestorImportacion.ejecutar-203"><span class="linenos">203</span></a>        <span class="k">if</span> <span class="n">esquema</span><span class="p">:</span>
</span><span id="GestorImportacion.ejecutar-204"><a href="#GestorImportacion.ejecutar-204"><span class="linenos">204</span></a>            <span class="n">esquema_ponderacion</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;porcentaje&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">esquema</span><span class="p">}</span>
</span><span id="GestorImportacion.ejecutar-205"><a href="#GestorImportacion.ejecutar-205"><span class="linenos">205</span></a>            <span class="n">columnas_disponibles</span> <span class="o">=</span> <span class="n">engine_pre</span><span class="o">.</span><span class="n">obtener_columnas_restantes</span><span class="p">()</span>
</span><span id="GestorImportacion.ejecutar-206"><a href="#GestorImportacion.ejecutar-206"><span class="linenos">206</span></a>
</span><span id="GestorImportacion.ejecutar-207"><a href="#GestorImportacion.ejecutar-207"><span class="linenos">207</span></a>            <span class="n">dialogo_mapeo</span> <span class="o">=</span> <span class="n">DialogoMapeoNotas</span><span class="p">(</span><span class="n">columnas_disponibles</span><span class="p">,</span> <span class="n">esquema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-208"><a href="#GestorImportacion.ejecutar-208"><span class="linenos">208</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dialogo_mapeo</span><span class="o">.</span><span class="n">exec</span><span class="p">():</span>
</span><span id="GestorImportacion.ejecutar-209"><a href="#GestorImportacion.ejecutar-209"><span class="linenos">209</span></a>                <span class="k">return</span>  <span class="c1"># Cancelado en mapeo</span>
</span><span id="GestorImportacion.ejecutar-210"><a href="#GestorImportacion.ejecutar-210"><span class="linenos">210</span></a>
</span><span id="GestorImportacion.ejecutar-211"><a href="#GestorImportacion.ejecutar-211"><span class="linenos">211</span></a>            <span class="n">mapa_actividades</span> <span class="o">=</span> <span class="n">dialogo_mapeo</span><span class="o">.</span><span class="n">obtener_mapeo</span><span class="p">()</span>
</span><span id="GestorImportacion.ejecutar-212"><a href="#GestorImportacion.ejecutar-212"><span class="linenos">212</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">mapa_actividades</span><span class="p">:</span>
</span><span id="GestorImportacion.ejecutar-213"><a href="#GestorImportacion.ejecutar-213"><span class="linenos">213</span></a>                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Info&quot;</span><span class="p">,</span> <span class="s2">&quot;No vinculó columnas. Se importarán solo datos personales.&quot;</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-214"><a href="#GestorImportacion.ejecutar-214"><span class="linenos">214</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GestorImportacion.ejecutar-215"><a href="#GestorImportacion.ejecutar-215"><span class="linenos">215</span></a>            <span class="n">resp_final</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="GestorImportacion.ejecutar-216"><a href="#GestorImportacion.ejecutar-216"><span class="linenos">216</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Importación Parcial&quot;</span><span class="p">,</span>
</span><span id="GestorImportacion.ejecutar-217"><a href="#GestorImportacion.ejecutar-217"><span class="linenos">217</span></a>                <span class="s2">&quot;⚠️ No hay esquema de evaluación.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion.ejecutar-218"><a href="#GestorImportacion.ejecutar-218"><span class="linenos">218</span></a>                <span class="s2">&quot;Se importarán SOLO los estudiantes y matrículas (Sin Calificaciones).</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="GestorImportacion.ejecutar-219"><a href="#GestorImportacion.ejecutar-219"><span class="linenos">219</span></a>                <span class="s2">&quot;¿Desea continuar?&quot;</span><span class="p">,</span>
</span><span id="GestorImportacion.ejecutar-220"><a href="#GestorImportacion.ejecutar-220"><span class="linenos">220</span></a>                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span>
</span><span id="GestorImportacion.ejecutar-221"><a href="#GestorImportacion.ejecutar-221"><span class="linenos">221</span></a>            <span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-222"><a href="#GestorImportacion.ejecutar-222"><span class="linenos">222</span></a>            <span class="k">if</span> <span class="n">resp_final</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span><span class="p">:</span>
</span><span id="GestorImportacion.ejecutar-223"><a href="#GestorImportacion.ejecutar-223"><span class="linenos">223</span></a>                <span class="k">return</span>
</span><span id="GestorImportacion.ejecutar-224"><a href="#GestorImportacion.ejecutar-224"><span class="linenos">224</span></a>
</span><span id="GestorImportacion.ejecutar-225"><a href="#GestorImportacion.ejecutar-225"><span class="linenos">225</span></a>        <span class="c1"># 4. Iniciar Worker</span>
</span><span id="GestorImportacion.ejecutar-226"><a href="#GestorImportacion.ejecutar-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>
</span><span id="GestorImportacion.ejecutar-227"><a href="#GestorImportacion.ejecutar-227"><span class="linenos">227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span> <span class="o">=</span> <span class="n">WorkerProcesamiento</span><span class="p">(</span>
</span><span id="GestorImportacion.ejecutar-228"><a href="#GestorImportacion.ejecutar-228"><span class="linenos">228</span></a>            <span class="n">archivo</span><span class="p">,</span> <span class="n">curso_seleccionado</span><span class="p">,</span> <span class="n">engine_pre</span><span class="o">.</span><span class="n">mapa_cols</span><span class="p">,</span>
</span><span id="GestorImportacion.ejecutar-229"><a href="#GestorImportacion.ejecutar-229"><span class="linenos">229</span></a>            <span class="n">mapa_actividades</span><span class="p">,</span> <span class="n">esquema_ponderacion</span>
</span><span id="GestorImportacion.ejecutar-230"><a href="#GestorImportacion.ejecutar-230"><span class="linenos">230</span></a>        <span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-231"><a href="#GestorImportacion.ejecutar-231"><span class="linenos">231</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-232"><a href="#GestorImportacion.ejecutar-232"><span class="linenos">232</span></a>
</span><span id="GestorImportacion.ejecutar-233"><a href="#GestorImportacion.ejecutar-233"><span class="linenos">233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-234"><a href="#GestorImportacion.ejecutar-234"><span class="linenos">234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_al_terminar_analisis</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">curso_seleccionado</span><span class="p">))</span>
</span><span id="GestorImportacion.ejecutar-235"><a href="#GestorImportacion.ejecutar-235"><span class="linenos">235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</span><span id="GestorImportacion.ejecutar-236"><a href="#GestorImportacion.ejecutar-236"><span class="linenos">236</span></a>
</span><span id="GestorImportacion.ejecutar-237"><a href="#GestorImportacion.ejecutar-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">quit</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-238"><a href="#GestorImportacion.ejecutar-238"><span class="linenos">238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_proc</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-239"><a href="#GestorImportacion.ejecutar-239"><span class="linenos">239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>
</span><span id="GestorImportacion.ejecutar-240"><a href="#GestorImportacion.ejecutar-240"><span class="linenos">240</span></a>
</span><span id="GestorImportacion.ejecutar-241"><a href="#GestorImportacion.ejecutar-241"><span class="linenos">241</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread_proc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Inicia el asistente de importación paso a paso.</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>